<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script>
        // Script per l'impostazione iniziale del tema (chiaro/scuro)
        (function() {
            try {
                // Carica il tema preferito dall'utente o imposta 'dark' come default.
                const theme = localStorage.getItem('cerbero_theme') || 'dark';
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-theme');
                }
            } catch (e) {
                console.error('Errore applicazione tema iniziale:', e);
            }
        })();
    </script>

    <title>CeRBERO - Sistema Gestionale</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        /* ==================================================
        |       FOGLIO DI STILE UNIFICATO - CeRBERO      |
        ==================================================
        | Questo blocco contiene tutti gli stili CSS     |
        | necessari per l'intera applicazione.           |
        | Inizia con gli stili comuni (Design System)    |
        | e prosegue con gli stili specifici per ogni    |
        | sezione (Registro, Carico, Vendite, etc.).     |
        ==================================================
        */

        /* ===== DESIGN SYSTEM E STILI GLOBALI ===== */
        :root {
            --primary-blue: #093fb4;
            --primary-blue-hover: #0730a3;
            --primary-blue-light: rgba(9, 63, 180, 0.1);
            --text-primary: #334155;
            --text-secondary: #64748b;
            --bg-primary: #f4f4f9;
            --bg-white: #ffffff;
            --bg-card: #ffffff;
            --bg-display: #f3f4f6;
            --success: #10b981;
            --danger: #ef4444;
            --info: #06b6d4;
            --warning: #f59e0b;
            --border-color: #e5e7eb;
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --radius-pill: 50px;
            --radius-squadrato: 4px;
            --sidebar-width: 220px;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 13px;
            --font-size-lg: 14px;
            --font-size-xl: 16px;
            --font-size-standard: 14px;
            --product-benzina: #00C851;
            --product-gasolio: #FFD700;
            --product-diesel: #FF4444;
            --product-hvolution: #2196F3;
            --product-adblue: #0ABAB5;
            --purple: #6f42c1;
            --orange: #ff9f00;
        }

        html.dark-theme {
            --primary-blue: #3b82f6;
            --primary-blue-hover: #2563eb;
            --primary-blue-light: rgba(59, 130, 246, 0.15);
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --bg-primary: #0f172a;
            --bg-white: #1e293b;
            --bg-card: #1e293b;
            --bg-display: #334155;
            --border-color: #374151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus {
            outline: none;
        }

        *:focus-visible {
            box-shadow: 0 0 0 2px var(--primary-blue-light);
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        body {
            font-family: 'Montserrat', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            line-height: 1.5;
            overflow-x: hidden;
            padding-left: var(--sidebar-width);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 20px;
        }

        .sidebar {
            width: var(--sidebar-width);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            padding: 16px 0;
            z-index: 100;
            border-right: 1px solid var(--border-color);
        }

        .sidebar-header {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-blue), #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 24px;
            letter-spacing: -0.025em;
            padding: 0 12px;
        }

        .nav {
            flex-grow: 1;
            padding: 0 8px;
        }

        .nav ul {
            list-style: none;
        }

        .nav a {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 10px 12px;
            margin-bottom: 2px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            font-size: var(--font-size-sm);
            gap: 10px;
            border-radius: var(--radius-md);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            cursor: pointer;
        }

        .nav a:hover {
            color: var(--primary-blue);
            background-color: var(--primary-blue-light);
            transform: translateX(2px);
        }

        .nav a.active {
            background: var(--primary-blue);
            color: white !important;
        }

        .nav a i {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border-color);
            padding: 12px 8px 0;
        }

        .sidebar-footer a {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            font-size: var(--font-size-sm);
            gap: 10px;
            text-transform: uppercase;
            border-radius: var(--radius-md);
            margin-bottom: 2px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .sidebar-footer a:hover {
            color: var(--primary-blue);
            background-color: var(--primary-blue-light);
        }
        
        .box {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .box:hover {
            transform: translateY(-1px);
        }

        .box-header {
            color: var(--primary-blue);
            font-size: var(--font-size-lg);
            font-weight: 700;
            text-transform: uppercase;
            padding: 12px 16px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            letter-spacing: 0.05em;
        }

        .box-content {
            padding: 16px;
            flex-grow: 1;
        }
        
        .action-btn {
            font-size: var(--font-size-sm);
            padding: 8px 16px;
            height: 36px;
            text-decoration: none;
            color: var(--text-secondary);
            background: var(--bg-card);
            font-weight: 600;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .action-btn:hover {
            color: var(--primary-blue);
            background-color: var(--primary-blue-light);
            border-color: var(--primary-blue);
            transform: translateY(-1px);
        }

        .action-btn.btn-success, .action-btn.btn-success:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .action-btn.btn-danger, .action-btn.btn-danger:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .top-action-bar {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            background-color: rgba(255,255,255,0.8);
            html.dark-theme & {
                background-color: rgba(30, 41, 59, 0.8);
            }
            padding: 8px 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            z-index: 99;
            border-bottom: 1px solid var(--border-color);
            transition: left 0.3s ease, width 0.3s ease;
            backdrop-filter: blur(10px);
            min-height: 52px;
        }

        .main-content {
            margin-top: 60px;
        }

        .grid-input, .display-field {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-weight: 500;
            background: var(--bg-white);
            color: var(--text-primary);
            text-align: center;
            transition: all 0.2s ease;
            font-size: var(--font-size-sm);
            min-height: 36px;
            box-sizing: border-box;
        }

        .grid-input:focus {
            border-color: var(--primary-blue);
        }

        .display-field, .grid-input[readonly] {
            background-color: var(--bg-display);
            cursor: default;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--bg-card); border-radius: var(--radius-xl);
            width: 100%; max-width: 480px; margin: 20px;
            border: 1px solid var(--border-color);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 1px solid var(--border-color);
        }
        .modal-title { font-size: var(--font-size-lg); font-weight: 700; text-transform: uppercase; color: var(--primary-blue); }
        .modal-close-btn {
            width: 32px; height: 32px; font-size: var(--font-size-lg); font-weight: bold;
            color: var(--text-secondary); background: transparent; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close-btn:hover { background-color: var(--danger); color: white; border-color: var(--danger); }
        .modal-content { padding: 20px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border-color); }
        
        .theme-icon-hidden { display: none !important; }

        .toast {
            position: fixed; top: 20px; right: 20px; padding: 12px 16px;
            border-radius: var(--radius-lg); font-family: 'Inter', sans-serif; font-weight: 600;
            font-size: var(--font-size-sm); z-index: 1001; max-width: 320px;
            animation: slideIn 0.3s ease-out;
        }
        .toast-info { background: var(--info); color: white; }
        .toast-success { background: var(--success); color: white; }
        .toast-warning { background: var(--warning); color: #1f2937; }
        .toast-error { background: var(--danger); color: white; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100px); } }

        /* ===== STILI SPECIFICI HOME DASHBOARD ===== */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .giornata-content { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; height: 100%; padding: 16px; }
        .time-date { text-align: center; margin-bottom: 16px; }
        #currentTime { font-size: 2rem; font-weight: 800; color: var(--primary-blue); line-height: 1.2; margin-bottom: 6px; font-feature-settings: 'tnum'; }
        #currentDateDisplay { font-size: var(--font-size-lg); color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-fields { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 240px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-weight: 600; color: var(--text-secondary); text-transform: uppercase; text-align: center; font-size: var(--font-size-xs); }
        .incasso-content { display: flex; flex-direction: column; gap: 12px; height: 100%; justify-content: center; align-items: center; }
        .incasso-group { display: flex; flex-direction: column; align-items: center; gap: 6px; width: 100%; max-width: 240px; }
        .incasso-label { font-weight: 700; color: var(--primary-blue); font-size: var(--font-size-xs); text-align: center; width: 100%; text-transform: uppercase; }
        .incasso-value { background-color: var(--bg-display); padding: 10px 12px; font-weight: 600; min-height: 36px; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-sm); width: 100%; border-radius: var(--radius-md); border: 1px solid var(--border-color);}
        .incasso-input { padding: 10px 12px; min-height: 36px; font-size: var(--font-size-sm); width: 100%; }
        .vendite-summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-grow: 1; }
        .vendite-totals { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); }
        .product-field { padding: 8px 12px; border-radius: var(--radius-md); font-weight: 600; background: var(--bg-display); font-size: var(--font-size-sm); min-height: 36px; border-left: 4px solid var(--primary-blue); cursor: default; text-transform: uppercase; display: flex; align-items: center; border: 1px solid var(--border-color);}
        .product-field.product-benzina { border-left-color: var(--product-benzina); } .product-field.product-gasolio { border-left-color: var(--product-gasolio); } .product-field.product-diesel { border-left-color: var(--product-diesel); } .product-field.product-hvolution { border-left-color: var(--product-hvolution); } .product-field.product-adblue { border-left-color: var(--product-adblue); }
        #notes-card textarea { width: 100%; height: 100%; min-height: 200px; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 12px; resize: none; font-size: var(--font-size-sm); background-color: var(--bg-white); color: var(--text-primary); font-family: inherit;}
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendar-header h4 { font-weight: 600; font-size: var(--font-size-lg); }
        .calendar-header button { background: var(--bg-display); border: 1px solid var(--border-color); padding: 6px; border-radius: var(--radius-md); width: 32px; height: 32px; font-size: var(--font-size-sm); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .calendar-grid > div { padding: 6px 4px; font-size: var(--font-size-sm); }
        .weekday { color: var(--text-secondary); font-size: var(--font-size-xs); font-weight: 600; text-transform: uppercase; }
        .day { cursor: pointer; border-radius: 50%; width: 28px; height: 28px; margin: auto; font-size: var(--font-size-sm); display:flex; align-items:center; justify-content:center;}
        .day:hover { background-color: var(--primary-blue-light); }
        .day.current-day { background-color: var(--primary-blue); color: white; }
        .day.other-month { opacity: 0.4; } .day.holiday { color: var(--danger); }
        .todo-input-group { display: flex; gap: 8px; margin-bottom: 16px; }
        .todo-input-group input { flex-grow: 1; padding: 8px 12px; min-height: 36px; }
        #addTodoBtn { width: 36px; height: 36px; }
        #todo-list { list-style: none; overflow-y: auto; flex-grow: 1; min-height: 180px; }
        #todo-list li { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; margin-bottom: 6px; background: var(--bg-display); border-radius: var(--radius-md); border: 1px solid var(--border-color);}
        #todo-list label { flex: 1; word-break: break-word; line-height: 1.4; font-size: var(--font-size-sm); }
        .todo-delete { background: none; border: none; cursor: pointer; width: 24px; height: 24px; }
        .todo-delete:hover { background-color: var(--danger); color: white; border-radius: 50%; }

        /* ===== STILI SPECIFICI REGISTRO ===== */
        .top-row-grid, .bottom-row-grid { display: grid; gap: 25px; margin-bottom: 25px; }
        .top-row-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .bottom-row-grid { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); margin-bottom: 0; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 15px; align-items: center; }
        .summary-label { font-weight: 600; background-color: var(--bg-display); border-radius: var(--radius-md); text-align: center; padding: 10px 15px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
        .summary-grid .grid-input { text-align: right; }
        .transaction-form-grid { display: grid; grid-template-columns: 140px 1fr 120px; gap: 10px; align-items: center; margin-bottom: 15px; }
        .history-toggle { text-align: center; cursor: pointer; font-weight: 600; padding: 12px 20px; border-radius: var(--radius-pill); margin: 20px auto; display: block; width: fit-content; }
        .history-toggle:hover { background-color: var(--bg-display); }
        .transactions-container { max-height: 0; overflow: hidden; opacity: 0; padding-right: 10px; transition: max-height 0.4s ease-out, opacity 0.4s ease-out; }
        .transactions-container.is-expanded { max-height: 300px; overflow-y: auto; opacity: 1; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--border-color); }
        .transaction-details { font-weight: 500; flex-grow: 1; word-break: break-word; }
        .transaction-date { font-size: 12px; color: var(--text-secondary); }
        .transaction-right-side { display: flex; align-items: center; gap: 10px; }
        .transaction-amount { font-weight: 600; white-space: nowrap; }
        .transaction-delete-btn { background: transparent; border: none; cursor: pointer; color: var(--text-secondary); font-size: 16px; width: 28px; height: 28px; }
        .box-total { margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--primary-blue); display: flex; justify-content: space-between; align-items: center; font-weight: 700; text-transform: uppercase; color: var(--primary-blue); }

        /* ===== STILI SPECIFICI CARICO ===== */
        .carico-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-value { font-size: 2.5rem !important; font-weight: 800 !important; color: var(--primary-blue) !important; margin-bottom: 5px !important; line-height: 1.1 !important; text-align: center !important; }
        .carico-main-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 25px; margin-top: 0; }
        .chart-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .carico-grid { display: grid; grid-template-columns: 120px repeat(6, 1fr); gap: 8px; align-items: center; }
        .grid-header { font-weight: 700; color: var(--text-secondary); font-size: 12px; text-align: center; text-transform: uppercase; }
        .product-label { font-weight: 600; font-size: var(--font-size-standard); padding: 10px 8px 10px 15px; border-radius: var(--radius-md); text-transform: uppercase; background: var(--bg-display); border-left: 5px solid var(--primary-blue); }
        .chart-container-adaptive { position: relative; width: 100%; height: 100%; min-height: 280px; }
        .table-body-scrollable { max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-top: none; }
        .history-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-standard); table-layout: fixed; }
        .history-table th, .history-table td { padding: 6px 4px; text-align: center; }
        .history-table thead th { background: var(--primary-blue); color: white; }
        .filter-container { background-color: var(--bg-card); padding: 15px; border-radius: var(--radius-lg); margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .product-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* ===== STILI SPECIFICI VENDITE ===== */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 25px; }
        .charts-grid { display: grid; gap: 20px; grid-template-columns: repeat(3, 1fr); }
        .charts-grid .box-content { position: relative; width: 100%; flex-grow: 1; height: 350px; }
        #modalityChart { max-width: 280px !important; max-height: 280px !important; margin: 0 auto; }
        
        /* ===== STILI SPECIFICI CREDITO ===== */
        .credito-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .clients-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .clients-grid .box { cursor: pointer; min-height: 80px; text-align: center; justify-content: center; border-left: 5px solid var(--primary-blue); }
        .clients-grid .box .client-name { font-size: 14px !important; font-weight: 700; color: var(--primary-blue); }
        .search-wrapper { position: relative; width: 100%; max-width: 300px; }
        #creditoSearchInput { width: 100%; padding: 10px 15px 10px 40px; border-radius: var(--radius-md); }
        .client-header { display: flex; align-items: center; justify-content: space-between; }
        .client-name-input { font-size: 18px; font-weight: 700; border: 2px solid transparent; background: transparent; }

        /* ===== STILI SPECIFICI MONETARIO ===== */
        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }
        .second-row-grid { display: grid; grid-template-columns: 2.5fr 1fr; gap: 25px; margin-bottom: 25px; }
        .pricing-grid { display: grid; gap: 10px; grid-template-columns: 140px repeat(3, 1fr); }
        .fuel-order-grid { display: grid; gap: 10px; grid-template-columns: auto 1fr 1fr; }
        .spinner-input-group { display: flex; align-items: stretch; border: 2px solid var(--border-color) !important; border-radius: var(--radius-md); height: 44px; overflow: hidden; }
        .spinner-btn { background: var(--bg-display); border: none; width: 40px; font-size: 20px !important; cursor: pointer; }
        .versamento-grid { display: grid; grid-template-columns: 50px 1fr 1fr; gap: 10px; }
        .versamento-banconota { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border-radius: var(--radius-md);}
        .euro-500 { background: var(--purple); } .euro-200 { background: var(--warning); color: #333; } .euro-100 { background: var(--success); } .euro-50 { background: var(--orange); } .euro-20 { background: var(--primary-blue); } .euro-10 { background: var(--danger); }
        
        /* ===== STILI SPECIFICI VIRTUALSTATION ===== */
        .main-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; }
        .virtualstation-grid { display: grid; grid-template-columns: 120px repeat(3, minmax(100px, 1fr)); gap: 8px; }
        .total-turn-grid { display: grid; grid-template-columns: 120px 1fr 1fr; gap: 8px; }
        .global-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        #turns-container .turn-block:not(:first-child) { margin-top: 40px; padding-top: 40px; border-top: 2px dashed var(--border-color); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; } }
        @media (max-width: 992px) { body { padding-left: 0; } .sidebar { left: -240px; } .sidebar.active { left: 0; } .top-action-bar { left: 0; width: 100%; } .dashboard-grid { grid-template-columns: 1fr; } .content-grid, .second-row-grid, .main-grid, .global-summary-grid, .stats-row, .charts-grid, .carico-summary-grid, .credito-summary-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="top-action-bar" id="topActionBar">
        </div>

    <aside class="sidebar" id="main-sidebar">
        <div class="sidebar-header">CeRBERO</div>
        <nav class="nav">
            <ul>
                <li><a class="nav-link active" data-section="home"><i class="fa-solid fa-house"></i>Home</a></li>
                <li><a class="nav-link" data-section="registro"><i class="fa-solid fa-book"></i>Registro</a></li>
                <li><a class="nav-link" data-section="monetario"><i class="fa-solid fa-coins"></i>Monetario</a></li>
                <li><a class="nav-link" data-section="virtualstation"><i class="fa-solid fa-gas-pump"></i>VirtualStation</a></li>
                <li><a class="nav-link" data-section="vendite"><i class="fa-solid fa-chart-line"></i>Vendite</a></li>
                <li><a class="nav-link" data-section="credito"><i class="fa-solid fa-credit-card"></i>Credito</a></li>
                <li><a class="nav-link" data-section="carico"><i class="fa-solid fa-truck"></i>Carico</a></li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <a id="theme-switcher" title="Cambia Tema">
                <i id="theme-icon-light" class="fa-solid fa-sun theme-icon-hidden"></i>
                <i id="theme-icon-dark" class="fa-solid fa-moon"></i>Tema
            </a>
            <a id="info-btn" title="Informazioni">
                <i class="fa-solid fa-circle-info"></i>Info
            </a>
        </div>
    </aside>

    <div class="container">
        <main class="main-content">
            
            <div class="page-section active" id="section-home">
                <div class="dashboard-grid">
                    <section class="box summary-box giornata-box">
                        <div class="box-header">Giornata di Lavoro</div>
                        <div class="box-content">
                            <div class="giornata-content">
                                <div class="time-date">
                                    <div id="currentTime"></div>
                                    <div id="currentDateDisplay"></div>
                                </div>
                                <div class="form-fields">
                                    <div class="form-group">
                                        <label for="controlTurno">Turno</label>
                                        <input type="text" class="grid-input" id="controlTurno" placeholder="Inserisci turno">
                                    </div>
                                    <div class="form-group">
                                        <label for="controlDate">Data Sistema</label>
                                        <input type="text" class="display-field" id="controlDate" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="box summary-box incasso-box">
                        <div class="box-header">Incasso Giornaliero</div>
                        <div class="box-content incasso-content">
                            <div class="incasso-group">
                                <span class="incasso-label">Fatturato Totale</span>
                                <input type="text" class="incasso-input grid-input" id="corrispettivi-fatturato" placeholder="€ 0,00" inputmode="decimal">
                            </div>
                            <div class="incasso-group">
                                <span class="incasso-label">Imponibile</span>
                                <span class="incasso-value" id="corrispettivi-imponibile">€ 0,00</span>
                            </div>
                            <div class="incasso-group">
                                <span class="incasso-label">IVA (22%)</span>
                                <span class="incasso-value" id="corrispettivi-iva">€ 0,00</span>
                            </div>
                            <div class="incasso-group">
                                <span class="incasso-label">Margine Stimato</span>
                                <span class="incasso-value" id="corrispettivi-margine">€ 0,00</span>
                            </div>
                        </div>
                    </section>
                    <section class="box summary-box vendite-summary-box">
                        <div class="box-header">Riepilogo Vendite</div>
                        <div class="box-content">
                            <div class="vendite-summary-grid">
                                <div class="product-field product-benzina">Benzina</div>
                                <div class="display-field" id="benzina-liters">0,00 L</div>
                                <div class="product-field product-gasolio">Gasolio</div>
                                <div class="display-field" id="gasolio-liters">0,00 L</div>
                                <div class="product-field product-diesel">Diesel+</div>
                                <div class="display-field" id="diesel-liters">0,00 L</div>
                                <div class="product-field product-hvolution">HVolution</div>
                                <div class="display-field" id="hvolution-liters">0,00 L</div>
                                <div class="product-field product-adblue">AdBlue</div>
                                <div class="display-field" id="adblue-liters">0,00 L</div>
                            </div>
                            <div class="vendite-totals">
                                <div class="product-field">Totale Litri</div>
                                <div class="display-field" id="total-liters">0,00 L</div>
                            </div>
                        </div>
                    </section>
                    <section class="box summary-box note-box" id="notes-card">
                        <div class="box-header">Note del Turno</div>
                        <div class="box-content">
                            <textarea id="notesArea" placeholder="Scrivi le tue note del turno..."></textarea>
                        </div>
                    </section>
                    <section class="box summary-box calendario-box" id="calendar-card">
                        <div class="box-header">Calendario</div>
                        <div class="box-content">
                            <div class="calendar-header">
                                <button id="calendarPrev"><i class="fa-solid fa-chevron-left"></i></button>
                                <h4 id="calendarTitle"></h4>
                                <button id="calendarNext"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                            <div class="calendar-grid">
                                <div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div><div class="weekday">Gio</div><div class="weekday">Ven</div><div class="weekday">Sab</div><div class="weekday">Dom</div>
                            </div>
                            <div class="calendar-grid" id="calendarDates"></div>
                        </div>
                    </section>
                    <section class="box summary-box todo-box" id="todo-card">
                        <div class="box-header">Task del Turno</div>
                        <div class="box-content">
                            <div class="todo-input-group">
                                <input type="text" class="grid-input" id="newTodoInput" placeholder="Aggiungi task del turno...">
                                <button id="addTodoBtn" class="action-btn"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <ul id="todo-list"></ul>
                        </div>
                    </section>
                </div>
            </div>

            <div class="page-section" id="section-registro">
                <div class="top-row-grid">
                    <div class="box summary-box">
                        <h2 class="box-header">INIZIO TURNO</h2>
                        <div class="box-content">
                            <div class="summary-grid">
                                <div class="summary-label">CASSA</div>
                                <div><input type="text" class="grid-input" id="cassa-inizio"></div>
                                <div class="summary-label">MONETE</div>
                                <div><input type="text" class="grid-input" id="monete-inizio"></div>
                                <div class="summary-label">ALTRO</div>
                                <div><input type="text" class="grid-input" id="altro-inizio"></div>
                                <div class="summary-label">ALTRO</div>
                                <div><input type="text" class="grid-input" id="altro2-inizio"></div>
                            </div>
                        </div>
                    </div>
                    <div class="box summary-box">
                        <h2 class="box-header">RIEPILOGO</h2>
                        <div class="box-content">
                            <div class="summary-grid">
                                <div class="summary-label">ENTRATE</div>
                                <div class="display-field" id="totale-entrate">€ 0,00</div>
                                <div class="summary-label">CARBURANTI</div>
                                <div class="display-field" id="totale-carburanti">€ 0,00</div>
                                <div class="summary-label">USCITE</div>
                                <div class="display-field" id="totale-uscite">€ 0,00</div>
                                <div class="summary-label">DIFFERENZA</div>
                                <div class="display-field" id="differenza">€ 0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="box summary-box">
                        <h2 class="box-header">FINE TURNO</h2>
                        <div class="box-content">
                            <div class="summary-grid">
                                <div class="summary-label">CONTANTI</div>
                                <div><input type="text" class="grid-input" id="contanti-fine"></div>
                                <div class="summary-label">MONETE</div>
                                <div><input type="text" class="grid-input" id="monete-fine"></div>
                                <div class="summary-label">P.O.S.</div>
                                <div><input type="text" class="grid-input" id="pos-fine"></div>
                                <div class="summary-label">BUONI</div>
                                <div><input type="text" class="grid-input" id="buoni-fine"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bottom-row-grid">
                    <div id="entrate-container"></div>
                    <div id="uscite-container"></div>
                </div>
            </div>

            <div class="page-section" id="section-monetario">
                <div class="content-grid">
                    <div class="box summary-box">
                        <h2 class="box-header">PREZZI APPLICATI ENILIVE</h2>
                        <div class="box-content">
                            <div class="pricing-grid">
                                <div class="grid-header">Prodotto</div>
                                <div class="grid-header">Consigliati</div>
                                <div class="grid-header">Iperself</div>
                                <div class="grid-header">Servito</div>
                                <div class="product-field product-benzina">BENZINA</div>
                                <input type="text" class="grid-input" data-product="benzina" data-type="consigliati" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="benzina" data-type="iperself" placeholder="€ 0,000" readonly>
                                <input type="text" class="grid-input" data-product="benzina" data-type="servito" placeholder="€ 0,000" readonly>
                                <div class="product-field product-diesel">DIESEL+</div>
                                <input type="text" class="grid-input" data-product="diesel" data-type="consigliati" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="diesel" data-type="iperself" placeholder="€ 0,000" readonly>
                                <input type="text" class="grid-input" data-product="diesel" data-type="servito" placeholder="€ 0,000" readonly>
                                <div class="product-field product-gasolio">GASOLIO</div>
                                <input type="text" class="grid-input" data-product="gasolio" data-type="consigliati" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="gasolio" data-type="iperself" placeholder="€ 0,000" readonly>
                                <input type="text" class="grid-input" data-product="gasolio" data-type="servito" placeholder="€ 0,000" readonly>
                                <div class="product-field product-hvolution">HVOLUTION</div>
                                <input type="text" class="grid-input" data-product="hvolution" data-type="consigliati" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="hvolution" data-type="iperself" placeholder="€ 0,000" readonly>
                                <input type="text" class="grid-input" data-product="hvolution" data-type="servito" placeholder="€ 0,000" readonly>
                                <div class="product-field product-adblue">ADBLUE</div>
                                <input type="text" class="grid-input" style="visibility: hidden;">
                                <input type="text" class="grid-input" style="visibility: hidden;" disabled>
                                <input type="text" class="grid-input" data-product="adblue" data-type="servito" placeholder="€ 0,000">
                            </div>
                        </div>
                    </div>
                    <div class="box summary-box">
                        <h2 class="box-header">MONITORAGGIO CONCORRENZA</h2>
                        <div class="box-content">
                            <div class="pricing-grid">
                                <div class="grid-header">Prodotto</div>
                                <div class="grid-header">MyOil</div>
                                <div class="grid-header">Esso</div>
                                <div class="grid-header">Q8</div>
                                <div class="product-field product-benzina">BENZINA</div>
                                <input type="text" class="grid-input" data-product="benzina" data-competitor="myoil" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="benzina" data-competitor="esso" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="benzina" data-competitor="q8" placeholder="€ 0,000">
                                <div class="product-field product-gasolio">GASOLIO</div>
                                <input type="text" class="grid-input" data-product="gasolio" data-competitor="myoil" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="gasolio" data-competitor="esso" placeholder="€ 0,000">
                                <input type="text" class="grid-input" data-product="gasolio" data-competitor="q8" placeholder="€ 0,000">
                                <div class="grid-header" style="grid-column: 1 / -1; border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 5px;">DIFFERENZA PREZZI</div>
                                <div class="product-field product-benzina">BENZINA</div>
                                <input type="text" class="grid-input" data-product="benzina" data-diff="myoil" placeholder="0,00" readonly>
                                <input type="text" class="grid-input" data-product="benzina" data-diff="esso" placeholder="0,00" readonly>
                                <input type="text" class="grid-input" data-product="benzina" data-diff="q8" placeholder="0,00" readonly>
                                <div class="product-field product-gasolio">GASOLIO</div>
                                <input type="text" class="grid-input" data-product="gasolio" data-diff="myoil" placeholder="0,00" readonly>
                                <input type="text" class="grid-input" data-product="gasolio" data-diff="esso" placeholder="0,00" readonly>
                                <input type="text" class="grid-input" data-product="gasolio" data-diff="q8" placeholder="0,00" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="second-row-grid">
                    <div class="box summary-box">
                        <h2 class="box-header">CALCOLO ORDINE CARBURANTI</h2>
                        <div class="box-content">
                            <div class="fuel-order-grid">
                                <div class="grid-header">Prodotto</div><div class="grid-header">Quantità</div><div class="grid-header">Importo</div>
                                <div class="product-field product-benzina">BENZINA</div>
                                <div class="spinner-input-group" data-fuel="benzina" data-step="1000"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" placeholder="0" data-fuel="benzina" data-field="quantity-value"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" data-fuel="benzina" data-field="amount" readonly>
                                <div class="product-field product-diesel">DIESEL+</div>
                                <div class="spinner-input-group" data-fuel="diesel" data-step="1000"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" placeholder="0" data-fuel="diesel" data-field="quantity-value"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" data-fuel="diesel" data-field="amount" readonly>
                                <div class="product-field product-gasolio">GASOLIO</div>
                                <div class="spinner-input-group" data-fuel="gasolio" data-step="1000"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" placeholder="0" data-fuel="gasolio" data-field="quantity-value"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" data-fuel="gasolio" data-field="amount" readonly>
                                <div class="product-field product-hvolution">HVOLUTION</div>
                                <div class="spinner-input-group" data-fuel="hvolution" data-step="1000"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" placeholder="0" data-fuel="hvolution" data-field="quantity-value"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" data-fuel="hvolution" data-field="amount" readonly>
                                <div></div>
                                <div class="display-field" id="total-quantity">0 L</div><div class="display-field" id="total-amount">€ 0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="box summary-box">
                        <h2 class="box-header">VERSAMENTO</h2>
                        <div class="box-content">
                            <div class="versamento-grid">
                                <div class="versamento-banconota euro-500">500</div>
                                <div class="spinner-input-group" data-denom="500" data-step="1"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" id="banconote-500" placeholder="0" min="0"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" id="valore-500" placeholder="€ 0,00" readonly>
                                <div class="versamento-banconota euro-200">200</div>
                                <div class="spinner-input-group" data-denom="200" data-step="1"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" id="banconote-200" placeholder="0" min="0"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" id="valore-200" placeholder="€ 0,00" readonly>
                                <div class="versamento-banconota euro-100">100</div>
                                <div class="spinner-input-group" data-denom="100" data-step="1"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" id="banconote-100" placeholder="0" min="0"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" id="valore-100" placeholder="€ 0,00" readonly>
                                <div class="versamento-banconota euro-50">50</div>
                                <div class="spinner-input-group" data-denom="50" data-step="1"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" id="banconote-50" placeholder="0" min="0"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" id="valore-50" placeholder="€ 0,00" readonly>
                                <div class="versamento-banconota euro-20">20</div>
                                <div class="spinner-input-group" data-denom="20" data-step="1"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" id="banconote-20" placeholder="0" min="0"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" id="valore-20" placeholder="€ 0,00" readonly>
                                <div class="versamento-banconota euro-10">10</div>
                                <div class="spinner-input-group" data-denom="10" data-step="1"><button class="spinner-btn decrement">-</button><input type="text" class="grid-input spinner-value" id="banconote-10" placeholder="0" min="0"><button class="spinner-btn increment">+</button></div>
                                <input type="text" class="grid-input" id="valore-10" placeholder="€ 0,00" readonly>
                                <div></div>
                                <div class="display-field" id="versamento-total-banconote">0</div><div class="display-field" id="versamento-total-importo">€ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-section" id="section-virtualstation">
                 <div class="global-summary-grid">
                    <div class="box summary-box">
                        <div class="stat-value" id="global-iperself-liters">0,00 L</div>
                        <div class="stat-details" id="global-iperself-amount">€ 0,00</div>
                        <div class="stat-label">Iperself</div>
                    </div>
                    <div class="box summary-box">
                        <div class="stat-value" id="global-servito-liters">0,00 L</div>
                        <div class="stat-details" id="global-servito-amount">€ 0,00</div>
                        <div class="stat-label">Servito</div>
                    </div>
                    <div class="box summary-box">
                        <div class="stat-value" id="global-self-service-liters">0,00 L</div>
                        <div class="stat-details" id="global-self-service-amount">€ 0,00</div>
                        <div class="stat-label">Self-Service</div>
                    </div>
                    <div class="box summary-box">
                        <div class="stat-value" id="global-total-liters">0,00 L</div>
                        <div class="stat-details" id="global-total-amount">€ 0,00</div>
                        <div class="stat-label">Generale</div>
                    </div>
                </div>
                <div id="turns-container">
                    <div class="turn-block" id="turn-block-template" style="display:none;"> 
                        <div class="main-grid">
                            <div class="box summary-box bottom-box-large">
                                <h2 class="box-header">INSERIMENTO DATI DA VIRTUALSTATION</h2>
                                <div class="box-content">
                                    <div class="virtualstation-grid">
                                        <div class="grid-header"></div><div class="grid-header">IPERSELF</div><div class="grid-header">SERVITO</div><div class="grid-header">SELF-SERVICE</div>
                                        <div class="product-field product-gasolio">GASOLIO</div><input type="text" class="grid-input" data-product="gasolio" data-type="iperself"><input type="text" class="grid-input" data-product="gasolio" data-type="servito"><input type="text" class="grid-input" data-product="gasolio" data-type="self-service">
                                        <div class="product-field product-diesel">DIESEL+</div><input type="text" class="grid-input" data-product="diesel" data-type="iperself"><input type="text" class="grid-input" data-product="diesel" data-type="servito"><input type="text" class="grid-input" data-product="diesel" data-type="self-service">
                                        <div class="product-field product-adblue">ADBLUE</div><input type="text" class="grid-input" data-product="adblue" data-type="iperself" style="visibility: hidden;" tabindex="-1"><input type="text" class="grid-input" data-product="adblue" data-type="servito"><input type="text" class="grid-input" data-product="adblue" data-type="self-service" style="visibility: hidden;" tabindex="-1">
                                        <div class="product-field product-benzina">BENZINA</div><input type="text" class="grid-input" data-product="benzina" data-type="iperself"><input type="text" class="grid-input" data-product="benzina" data-type="servito"><input type="text" class="grid-input" data-product="benzina" data-type="self-service">
                                        <div class="product-field product-hvolution">HVOLUTION</div><input type="text" class="grid-input" data-product="hvolution" data-type="iperself"><input type="text" class="grid-input" data-product="hvolution" data-type="servito"><input type="text" class="grid-input" data-product="hvolution" data-type="self-service">
                                        <div class="grid-header total-row-header">TOTALE</div><div class="display-field total-row-cell total-row-iperself" data-total-type="iperself">0,00</div><div class="display-field total-row-cell total-row-servito" data-total-type="servito">0,00</div><div class="display-field total-row-cell total-row-self-service" data-total-type="self-service">0,00</div>
                                    </div>
                                </div>
                            </div>
                            <div class="box summary-box bottom-box-small">
                                <div class="box-header" style="justify-content: space-between;">
                                    <span>TURNO</span>
                                    <div class="turn-controls" style="display:flex; align-items:center; gap: 8px;"><input type="number" class="grid-input turn-number-input" min="0" max="9999" style="width: 80px; text-align:center;"><button class="action-btn btn-danger" style="width: 36px; padding: 0;" title="Elimina Turno"><i class="fa-solid fa-trash"></i></button></div>
                                </div>
                                <div class="box-content">
                                    <div class="total-turn-grid">
                                        <div class="grid-header">PRODOTTO</div><div class="grid-header">LITRI</div><div class="grid-header">IMPORTO</div>
                                        <div class="product-field product-gasolio">GASOLIO</div><div class="display-field" data-total-product="gasolio" data-total-field="liters">0,00</div><div class="display-field" data-total-product="gasolio" data-total-field="amount">€ 0,00</div>
                                        <div class="product-field product-diesel">DIESEL+</div><div class="display-field" data-total-product="diesel" data-total-field="liters">0,00</div><div class="display-field" data-total-product="diesel" data-total-field="amount">€ 0,00</div>
                                        <div class="product-field product-adblue">ADBLUE</div><div class="display-field" data-total-product="adblue" data-total-field="liters">0,00</div><div class="display-field" data-total-product="adblue" data-total-field="amount">€ 0,00</div>
                                        <div class="product-field product-benzina">BENZINA</div><div class="display-field" data-total-product="benzina" data-total-field="liters">0,00</div><div class="display-field" data-total-product="benzina" data-total-field="amount">€ 0,00</div>
                                        <div class="product-field product-hvolution">HVOLUTION</div><div class="display-field" data-total-product="hvolution" data-total-field="liters">0,00</div><div class="display-field" data-total-product="hvolution" data-total-field="amount">€ 0,00</div>
                                        <div class="grid-header">TOTALE</div><div class="display-field total-general-liters">0,00</div><div class="display-field total-general-amount">€ 0,00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-section" id="section-vendite">
                <div class="filter-container">
                    <label class="filter-label">Filtra Dati Per:</label>
                    <select id="vendite-filter-type" class="grid-input filter-select">
                        <option value="mese">MESE</option>
                        <option value="trimestre">TRIMESTRE</option>
                        <option value="semestre">SEMESTRE</option>
                    </select>
                    <select id="vendite-filter-value" class="grid-input filter-select"></select>
                    <button class="action-btn" id="btn-apply-vendite-filter"><i class="fa-solid fa-check"></i>Applica</button>
                    <button class="action-btn" id="btn-reset-vendite-filter" title="Reset Filtro"><i class="fa-solid fa-rotate-left"></i></button>
                </div>
                <div class="stats-row">
                    <div class="box summary-box"><div class="stat-value" id="totalSales">€ 0,00</div><div class="stat-label">Fatturato Totale</div></div>
                    <div class="box summary-box"><div class="stat-value" id="totalLitersVendite">0 L</div><div class="stat-label">Litri Erogati</div></div>
                    <div class="box summary-box"><div class="stat-value" id="servitoPerc">0%</div><div class="stat-label">Servito vs Self</div></div>
                </div>
                <div class="charts-grid">
                    <div class="box"><h2 class="box-header">Vendite per Prodotto</h2><div class="box-content"><canvas id="productChart"></canvas></div></div>
                    <div class="box"><h2 class="box-header">Modalità di Servizio</h2><div class="box-content pie-chart-container"><canvas id="modalityChart"></canvas></div></div>
                    <div class="box"><h2 class="box-header">Composizione Fatturato</h2><div class="box-content"><canvas id="islandChart"></canvas></div></div>
                </div>
            </div>

            <div class="page-section" id="section-credito">
                <div class="credito-summary-grid">
                    <div class="box summary-box"><div class="summary-title">Clienti a Debito</div><div class="summary-value stat-value" id="clientiAttivi">0</div></div>
                    <div class="box summary-box"><div class="summary-title">Credito Totale</div><div class="summary-value stat-value" id="totalCredito">€ 0,00</div></div>
                    <div class="box summary-box"><div class="summary-title">Ultima Operazione</div><div class="summary-value stat-value" id="last-op-client" style="font-size: 18px;">--</div><div class="summary-details" id="last-op-details"></div></div>
                </div>
                <main id="clientsGrid" class="clients-grid"></main>
            </div>

            <div class="page-section" id="section-carico">
                 <div class="filter-container">
                    <label class="filter-label">Filtra Totali Per:</label>
                    <select id="carico-filter-type" class="grid-input filter-select"><option value="mese">MESE</option><option value="trimestre">TRIMESTRE</option><option value="semestre">SEMESTRE</option></select>
                    <select id="carico-filter-value" class="grid-input filter-select"></select>
                    <button class="action-btn" id="btn-apply-carico-filter"><i class="fa-solid fa-check"></i>Applica</button>
                    <button class="action-btn" id="btn-reset-carico-filter" title="Reset Filtro"><i class="fa-solid fa-rotate-left"></i></button>
                </div>
                <div class="carico-summary-grid">
                    <div class="box summary-box"><div class="summary-title">Totale Prodotti Caricati</div><div class="summary-value stat-value" id="totaleProdottiCaricati">0 L</div></div>
                    <div class="box summary-box"><div class="summary-title">Prodotto Più Caricato</div><div class="summary-value stat-value" id="prodottoPiuCaricato">--</div><div class="summary-details" id="prodottoPiuCaricatoDettagli"></div></div>
                    <div class="box summary-box"><div class="summary-title">Autista Top</div><div class="summary-value stat-value" id="autistaTop">--</div><div class="summary-details" id="autistaTopDettagli"></div></div>
                </div>
                <div class="carico-main-container">
                    <div class="box summary-box" id="box-sinistro">
                        <h2 class="box-header" id="box-title-anno">TOTALE ANNO</h2>
                        <div class="box-content">
                            <div class="carico-grid">
                                <div class="grid-header">Prodotto</div><div class="grid-header">Litri</div><div class="grid-header hide-mobile">PIÙ</div><div class="grid-header hide-mobile">MENO</div><div class="grid-header hide-mobile">Differenza</div><div class="grid-header hide-mobile hide-on-filter" id="rimanenza-header">RIMANENZA</div><div class="grid-header hide-mobile hide-on-filter">Totale</div>
                                <div class="product-label product-benzina">BENZINA</div><div><input type="text" class="grid-input" id="litri-benzina" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="piu-benzina" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="meno-benzina" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="diff-benzina" readonly></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="rimanenza-benzina"></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="totale-benzina" readonly></div>
                                <div class="product-label product-gasolio">GASOLIO</div><div><input type="text" class="grid-input" id="litri-gasolio" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="piu-gasolio" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="meno-gasolio" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="diff-gasolio" readonly></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="rimanenza-gasolio"></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="totale-gasolio" readonly></div>
                                <div class="product-label product-diesel">DIESEL+</div><div><input type="text" class="grid-input" id="litri-diesel" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="piu-diesel" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="meno-diesel" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="diff-diesel" readonly></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="rimanenza-diesel"></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="totale-diesel" readonly></div>
                                <div class="product-label product-hvolution">HVOLUTION</div><div><input type="text" class="grid-input" id="litri-hvolution" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="piu-hvolution" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="meno-hvolution" readonly></div><div class="hide-mobile"><input type="text" class="grid-input" id="diff-hvolution" readonly></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="rimanenza-hvolution"></div><div class="hide-mobile hide-on-filter"><input type="text" class="grid-input" id="totale-hvolution" readonly></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-row">
                    <div class="box summary-box"><h2 class="box-header">GRAFICO CARICHI</h2><div class="box-content"><div class="chart-container-adaptive"><canvas id="carichiChart"></canvas></div></div></div>
                    <div class="box summary-box"><h2 class="box-header">ANDAMENTO CARICHI MENSILI</h2><div class="box-content"><div class="chart-container-adaptive"><canvas id="monthlyLoadChart"></canvas></div></div></div>
                </div>
                <div class="box summary-box" id="box-inferiore">
                    <h2 class="box-header">STORICO CARICHI</h2>
                    <div class="box-content">
                        <div class="table-header-fixed"><table class="history-table"><thead><tr><th>Data</th><th>Benzina</th><th>+/-</th><th>Gasolio</th><th>+/-</th><th>Diesel+</th><th>+/-</th><th>HVOlution</th><th>+/-</th><th>Autista</th><th></th></tr></thead></table></div>
                        <div class="table-body-scrollable"><table class="history-table"><tbody id="history-tbody"></tbody></table></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div class="modal-overlay" id="info-modal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title">Informazioni Sistema</div><button class="modal-close-btn" title="Chiudi"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-content info-modal-content" style="text-align: center;">
                <i class="fa-solid fa-brain" style="font-size: 48px; color: var(--primary-blue); margin-bottom: 16px;"></i>
                <div style="font-size: 24px; font-weight: 800; margin-bottom: 12px; background: linear-gradient(135deg, var(--primary-blue), #06b6d4);-webkit-background-clip: text;-webkit-text-fill-color: transparent;">CeRBERO</div>
                <p>Sistema di gestione modernizzato per stazioni di servizio.</p>
                <div style="font-size: var(--font-size-sm); border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 12px; line-height: 1.6;">
                    <strong>Sviluppato da:</strong> NeRO<br>
                    <a href="mailto:tito.neroni@gmail.com" style="color: var(--text-primary);">tito.neroni@gmail.com</a><br>
                    <a href="https://github.com/tytus44/cerbero" target="_blank" style="color: var(--text-primary);">Progetto su GitHub</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="confirm-modal-title">Conferma Operazione</div><button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-content"><p id="confirm-modal-text">Sei sicuro di voler procedere?</p></div>
            <div class="modal-actions"><button class="action-btn" id="confirm-modal-cancel"><i class="fa-solid fa-xmark"></i>Annulla</button><button class="action-btn btn-success" id="confirm-modal-ok"><i class="fa-solid fa-check"></i>Conferma</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="add-client-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title">Aggiungi Nuovo Cliente</h3><button class="modal-close-btn" title="Chiudi"><i class="fa-solid fa-xmark"></i></button></div><div class="modal-content"><div class="add-client-form"><input type="text" id="new-client-name" class="grid-input" placeholder="Nome del cliente"></div></div><div class="modal-actions"><button class="action-btn" id="add-client-cancel"><i class="fa-solid fa-xmark"></i> Annulla</button><button class="action-btn btn-success" id="add-client-ok"><i class="fa-solid fa-check"></i> Aggiungi</button></div></div></div>
    <div class="modal-overlay" id="acconto-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title">Aggiungi Acconto</h3></div><div class="modal-content"><p>Inserisci l'importo per <strong id="acconto-client-name"></strong>.</p><div class="acconto-form"><input type="text" id="acconto-amount-input" class="grid-input" placeholder="€ 0,00" inputmode="decimal"></div></div><div class="modal-actions"><button class="action-btn" id="acconto-cancel-btn"><i class="fa-solid fa-xmark"></i> Annulla</button><button class="action-btn btn-success" id="acconto-ok-btn"><i class="fa-solid fa-check"></i> Conferma</button></div></div></div>
    <div class="modal-overlay" id="client-detail-modal"><div class="modal" id="modal-content-wrapper" style="max-width: 700px; max-height: 90vh; overflow-y: auto;"><div id="modal-body-content"></div></div></div>
    <div class="modal-overlay" id="newLoadModal"><div class="modal" style="max-width: 600px;"><div class="modal-header"><h3 class="modal-title">Nuovo Carico</h3><button class="modal-close-btn" id="btn-close-modal" title="Chiudi"><i class="fa-solid fa-xmark"></i></button></div><div class="modal-content"><form class="modal-form" id="newLoadForm"><div class="form-row"><div class="form-group"><label>Data</label><input type="text" class="grid-input" id="load-date" required></div><div class="form-group"><label>Autista</label><input type="text" class="grid-input" id="load-driver" required></div></div><div class="product-inputs"><div class="form-group"><label class="product-label product-benzina">Benzina</label><input type="number" class="grid-input" id="load-benzina" placeholder="Litri"><input type="number" class="grid-input" id="load-diff-benzina" placeholder="+/-"></div><div class="form-group"><label class="product-label product-gasolio">Gasolio</label><input type="number" class="grid-input" id="load-gasolio" placeholder="Litri"><input type="number" class="grid-input" id="load-diff-gasolio" placeholder="+/-"></div><div class="form-group"><label class="product-label product-diesel">Diesel+</label><input type="number" class="grid-input" id="load-diesel" placeholder="Litri"><input type="number" class="grid-input" id="load-diff-diesel" placeholder="+/-"></div><div class="form-group"><label class="product-label product-hvolution">HVOlution</label><input type="number" class="grid-input" id="load-hvolution" placeholder="Litri"><input type="number" class="grid-input" id="load-diff-hvolution" placeholder="+/-"></div></div><div class="modal-actions"><button type="button" class="action-btn" id="btn-cancel-modal"><i class="fa-solid fa-xmark"></i>Annulla</button><button type="submit" class="action-btn btn-success"><i class="fa-solid fa-check"></i>Salva</button></div></form></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    /* ================================================== */
    /* ===== 1. STORAGE & THEME MANAGER (da storage.js) ===== */
    /* ================================================== */
    const Storage = {
        KEYS: {
            THEME: 'cerbero_theme',
            NOTES: 'cerbero_notes',
            TODO_LIST: 'cerbero_todo',
            CURRENT_TURNO: 'cerbero_turno',
            REGISTRO_DATA: 'cerbero_registro',
            MONETARIO_DATA: 'cerbero_monetario',
            VIRTUALSTATION_DATA: 'cerbero_virtual_station_data',
            VERSAMENTO_DATA: 'cerbero_versamento',
            ORDER_HISTORY: 'cerbero_order_history',
            CREDITO_DATA: 'cerbero_credito',
            ELABORAZIONE_DATA: 'cerbero_elaborazione_data',
            CARICO_TOTALS: 'cerbero_carico_totals',
            CARICO_HISTORY: 'cerbero_carico_history',
            CARICO_RIMANENZE: 'cerbero_carico_rimanenze',
            VENDITE_HISTORY: 'cerbero_vendite_history',
            HISTORY_COLLAPSED: 'cerbero_carico_history_collapsed',
            CORRISPETTIVI_FATTURATO_MANUALE: 'cerbero_corrispettivi_manuale'
        },
        _plainTextKeys: [
            'cerbero_theme', 
            'cerbero_notes', 
            'cerbero_turno',
            'cerbero_carico_history_collapsed'
        ],
        save: function(key, data) {
            try {
                const dataToStore = this._plainTextKeys.includes(key) ? data : JSON.stringify(data);
                localStorage.setItem(key, dataToStore);
            } catch (error) {
                console.error(`[STORAGE] Errore nel salvare i dati per la chiave "${key}":`, error);
            }
        },
        load: function(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                if (data === null) return defaultValue;
                return this._plainTextKeys.includes(key) ? data : JSON.parse(data);
            } catch (error) {
                console.error(`[STORAGE] Errore nel caricare i dati per la chiave "${key}":`, error);
                return defaultValue;
            }
        },
        remove: function(key) {
            localStorage.removeItem(key);
        },
    };

    const ThemeManager = {
        init: function() {
            const themeSwitcher = document.getElementById('theme-switcher');
            this.updateIcons();
            if (themeSwitcher) {
                themeSwitcher.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.toggleTheme();
                });
            }
        },
        toggleTheme: function() {
            const isDark = document.documentElement.classList.toggle('dark-theme');
            const newTheme = isDark ? 'dark' : 'light';
            Storage.save(Storage.KEYS.THEME, newTheme);
            this.updateIcons();
            window.dispatchEvent(new CustomEvent('theme-changed'));
        },
        updateIcons: function() {
            const isDark = document.documentElement.classList.contains('dark-theme');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (lightIcon && darkIcon) {
                lightIcon.classList.toggle('theme-icon-hidden', isDark);
                darkIcon.classList.toggle('theme-icon-hidden', !isDark);
            }
        }
    };

    /* ================================================== */
    /* ===== 2. UTILITY & HELPER GLOBALI ===== */
    /* ================================================== */

    function showMessage(message, type = 'info') {
        try {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        } catch (error) { console.error('Errore visualizzazione messaggio:', error); alert(message); }
    }

    function showConfirmModal(title, text, onConfirm) {
        const modal = document.getElementById('confirm-modal');
        if (!modal) {
            if (confirm(`${title}\n${text}`)) onConfirm();
            return;
        }
        modal.querySelector('#confirm-modal-title').textContent = title;
        modal.querySelector('#confirm-modal-text').textContent = text;
        const btnOk = modal.querySelector('#confirm-modal-ok');
        const newBtnOk = btnOk.cloneNode(true);
        btnOk.parentNode.replaceChild(newBtnOk, btnOk);
        
        const hideModal = () => modal.classList.remove('active');
        
        newBtnOk.addEventListener('click', () => { onConfirm(); hideModal(); }, { once: true });
        
        const btnCancel = modal.querySelector('#confirm-modal-cancel');
        const newBtnCancel = btnCancel.cloneNode(true);
        btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);
        newBtnCancel.addEventListener('click', hideModal, { once: true });

        const closeBtn = modal.querySelector('.modal-close-btn');
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        newCloseBtn.addEventListener('click', hideModal, { once: true });
        
        modal.classList.add('active');
    }

    const formatter = {
        liters: (value) => {
            if (typeof value !== 'number' || isNaN(value)) return '0';
            return new Intl.NumberFormat('it-IT').format(Math.round(value));
        },
        currency: new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }),
        diff: new Intl.NumberFormat('it-IT', { signDisplay: 'always' }),
        toLocaleDate: (date) => {
            if (!(date instanceof Date) || isNaN(date)) return '';
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        },
        dateTime: (dateStr) => {
            return new Date(dateStr).toLocaleString('it-IT', { 
                day: '2-digit', month: '2-digit', year: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            }); 
        },
        fuelPrices: new Intl.NumberFormat('it-IT', { minimumFractionDigits: 3, maximumFractionDigits: 3 }),
        litersDecimal: new Intl.NumberFormat('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
    };

    function parseNumberInput(value) {
        try {
            if (typeof value !== 'string') value = String(value);
            const cleaned = value.replace(/€/g, '').replace(/\./g, '').replace(/,/, '.').trim();
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        } catch (error) { console.error('Errore parsing numero:', error); return 0; }
    }
    
    function parseDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return null;
        let date = null;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                date = new Date(year, month, day, 12, 0, 0, 0);
            }
        } else if (dateStr.includes('-')) {
            const isoDate = dateStr.split('T')[0];
            const parts = isoDate.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);
                date = new Date(year, month, day, 12, 0, 0, 0);
            }
        }
        return (date && !isNaN(date)) ? date : null;
    };
    
    function createDateTimestamp(dateStr) {
        const parsedDate = parseDate(dateStr);
        return parsedDate ? parsedDate.toISOString() : null;
    };

    function initializeInfoButton() {
        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        const modalCloseBtn = infoModal ? infoModal.querySelector('.modal-close-btn') : null;
        if (infoBtn && infoModal) {
            infoBtn.addEventListener('click', (e) => {
                e.preventDefault();
                infoModal.classList.add('active');
            });
            if (modalCloseBtn) modalCloseBtn.addEventListener('click', () => infoModal.classList.remove('active'));
            infoModal.addEventListener('click', (e) => { if (e.target === infoModal) infoModal.classList.remove('active'); });
        }
    }
    
    function setupDateInputAutoComplete(input) {
        if (!input) return;
        const formatDate = () => {
            const parts = input.value.trim().match(/^(\d{1,2})[\/-](\d{1,2})$/);
            if (parts) {
                input.value = `${String(parts[1]).padStart(2, '0')}/${String(parts[2]).padStart(2, '0')}/${new Date().getFullYear()}`;
            }
        };
        input.addEventListener('blur', formatDate);
        input.addEventListener('keydown', e => { if (e.key === 'Enter') formatDate(); });
    }

    /* ================================================== */
    /* ===== 3. DEFINIZIONI DEI MODULI (Classi/Oggetti) ===== */
    /* ================================================== */

    // Modulo HOME (da index.js)
    const HomeManager = (() => {
        class HomeManager {
            constructor() {
                this.calendarWidget = null;
                this.todoWidget = null;
                this.VAT_RATE = 0.22;
                this.MARGIN_NON_SERVITO = 0.035;
                this.MARGIN_SERVITO = 0.065;
            }
            
            init() {
                this.calendarWidget = new CalendarWidget();
                this.todoWidget = new TodoWidget();
                this.bindEvents();
                this.loadInitialData();
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 60000);
            }

            bindEvents() {
                const turnoInput = document.getElementById('controlTurno');
                if (turnoInput) {
                    turnoInput.addEventListener('change', (e) => Storage.save(Storage.KEYS.CURRENT_TURNO, e.target.value));
                }
                const notesArea = document.getElementById('notesArea');
                if (notesArea) {
                    notesArea.addEventListener('input', this.debounce(() => Storage.save(Storage.KEYS.NOTES, notesArea.value), 500));
                }
                const fatturatoInput = document.getElementById('corrispettivi-fatturato');
                if (fatturatoInput) {
                     const handleFatturatoChange = this.debounce(() => {
                        const manualValue = parseNumberInput(fatturatoInput.value);
                        Storage.save(Storage.KEYS.CORRISPETTIVI_FATTURATO_MANUALE, manualValue);
                        this.updateIncassoBox(manualValue);
                    }, 400);
                    fatturatoInput.addEventListener('input', handleFatturatoChange);
                    fatturatoInput.addEventListener('focus', () => {
                        const rawValue = parseNumberInput(fatturatoInput.value);
                        fatturatoInput.value = rawValue === 0 ? '' : String(rawValue).replace('.', ',');
                        fatturatoInput.select();
                    });
                    fatturatoInput.addEventListener('blur', () => {
                        const finalValue = parseNumberInput(fatturatoInput.value);
                        fatturatoInput.value = formatter.currency.format(finalValue);
                    });
                }
            }

            loadInitialData() {
                const turnoInput = document.getElementById('controlTurno');
                if (turnoInput) turnoInput.value = Storage.load(Storage.KEYS.CURRENT_TURNO, '');

                const notesArea = document.getElementById('notesArea');
                if (notesArea) notesArea.value = Storage.load(Storage.KEYS.NOTES, '');

                this.initializeIncassoBox();
                this.updateSalesSummaryWidget();
                this.updateMarginBox();
            }
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => { clearTimeout(timeout); func(...args); };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            updateDateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const dateString = now.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
                const dateInputString = now.toLocaleDateString('it-IT');
                document.getElementById('currentTime').textContent = timeString;
                document.getElementById('currentDateDisplay').textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
                document.getElementById('controlDate').value = dateInputString;
            }
            
            getSalesSummaryData() {
                const virtualstationData = Storage.load(Storage.KEYS.VIRTUALSTATION_DATA, {});
                const productTotals = { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0, adblue: 0 };
                const modalityTotals = { servito: 0, iperself: 0, selfservice: 0 };
                for (const key in virtualstationData) {
                    if (key.startsWith('turn-')) {
                        const turnData = virtualstationData[key];
                        if (turnData && typeof turnData === 'object') {
                            for (const product in productTotals) {
                                const pInfo = turnData[product] || {};
                                productTotals[product] += pInfo.totalLiters || 0;
                                modalityTotals.servito += pInfo.servito || 0;
                                modalityTotals.iperself += pInfo.iperself || 0;
                                modalityTotals.selfservice += pInfo['self-service'] || 0;
                            }
                        }
                    }
                }
                return { productTotals, modalityTotals };
            }

            updateSalesSummaryWidget() {
                const { productTotals } = this.getSalesSummaryData();
                Object.entries(productTotals).forEach(([product, liters]) => {
                    document.getElementById(`${product}-liters`).textContent = `${formatter.litersDecimal.format(liters)} L`;
                });
                const totalLiters = Object.values(productTotals).reduce((sum, liters) => sum + liters, 0);
                document.getElementById('total-liters').textContent = `${formatter.litersDecimal.format(totalLiters)} L`;
            }

            calculateFatturatoFromVenditeData() {
                const virtualstationData = Storage.load(Storage.KEYS.VIRTUALSTATION_DATA, {});
                return virtualstationData?.globalTotals?.general?.amount || 0;
            }

            updateIncassoBox(fatturatoValue) {
                const imponibile = fatturatoValue / (1 + this.VAT_RATE);
                const iva = fatturatoValue - imponibile;
                document.getElementById('corrispettivi-imponibile').textContent = formatter.currency.format(imponibile);
                document.getElementById('corrispettivi-iva').textContent = formatter.currency.format(iva);
            }

            updateMarginBox() {
                const { modalityTotals } = this.getSalesSummaryData();
                const nonServitoLiters = modalityTotals.iperself + modalityTotals.selfservice;
                const servitoLiters = modalityTotals.servito;
                const totalMargin = (nonServitoLiters * this.MARGIN_NON_SERVITO) + (servitoLiters * this.MARGIN_SERVITO);
                document.getElementById('corrispettivi-margine').textContent = formatter.currency.format(totalMargin);
            }

            initializeIncassoBox() {
                const fatturatoInput = document.getElementById('corrispettivi-fatturato');
                if (!fatturatoInput) return;
                const savedManualFatturato = Storage.load(Storage.KEYS.CORRISPETTIVI_FATTURATO_MANUALE, null);
                let initialFatturato = (savedManualFatturato !== null) ? parseNumberInput(savedManualFatturato) : this.calculateFatturatoFromVenditeData();
                fatturatoInput.value = formatter.currency.format(initialFatturato);
                this.updateIncassoBox(initialFatturato);
            }

            confirmNewDay() {
                showConfirmModal('Avvia Nuova Giornata?', 'Salverà un backup completo e azzererà i dati giornalieri (Registro, Virtualstation, Fatturato). Procedere?', () => {
                    try {
                        this.esportaTuttiIDatiConfirmBypass();
                        showMessage('Backup completo eseguito!', 'success');
                        
                        Storage.remove(Storage.KEYS.REGISTRO_DATA);
                        const vsData = Storage.load(Storage.KEYS.VIRTUALSTATION_DATA, {});
                        const clearedVsData = { globalTotals: vsData.globalTotals || {} };
                        Storage.save(Storage.KEYS.VIRTUALSTATION_DATA, clearedVsData);
                        Storage.remove(Storage.KEYS.CORRISPETTIVI_FATTURATO_MANUALE);
                        
                        showMessage('Dati giornalieri azzerati. Ricarico la pagina...', 'info');
                        setTimeout(() => window.location.reload(), 2000);
                    } catch(e) {
                        showMessage("Errore nell'esportazione. L'operazione è stata annullata.", 'error');
                    }
                });
            }
            
            esportaTuttiIDati(showConfirmation = true) {
                const performExport = () => {
                     try {
                        const dataToExport = { exportDate: new Date().toISOString(), exportType: 'COMPLETE_SYSTEM_BACKUP' };
                        Object.keys(Storage.KEYS).forEach(key => {
                            const data = Storage.load(key);
                            if (data !== null) dataToExport[key] = data;
                        });
                        const dataStr = JSON.stringify(dataToExport, null, 2);
                        const blob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `cerbero_backup_completo_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        if (showConfirmation) showMessage('Backup completo esportato!', 'info');
                    } catch (error) {
                        if (showConfirmation) showMessage('Errore durante l\'esportazione completa.', 'error');
                        throw error;
                    }
                };
                if (showConfirmation) {
                    showConfirmModal('Esportare Tutti i Dati?', 'Verrà creato un backup completo di tutte le pagine. Continuare?', performExport);
                } else {
                    performExport();
                }
            }

            esportaTuttiIDatiConfirmBypass() {
                this.esportaTuttiIDati(false);
            }

            importaDatiCompleti() {
                showConfirmModal('Importare Tutti i Dati?', 'Sovrascriverà TUTTI i dati di tutte le pagine. Procedere?', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                let importedCount = 0;
                                Object.keys(Storage.KEYS).forEach(key => {
                                    if (importedData.hasOwnProperty(key)) {
                                        Storage.save(key, importedData[key]);
                                        importedCount++;
                                    }
                                });
                                if (importedCount === 0) { showMessage('Nessun dato valido trovato nel file.', 'warning'); return; }
                                showMessage(`${importedCount} sezioni importate! Ricarico...`, 'info');
                                setTimeout(() => window.location.reload(), 1500);
                            } catch (error) { showMessage('Errore: file non valido o corrotto.', 'error'); }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                });
            }
        }
        
        class CalendarWidget {
            constructor() { this.currentDate = new Date(); this.init(); }
            init() { this.render(); document.getElementById('calendarPrev').addEventListener('click', () => { this.currentDate.setMonth(this.currentDate.getMonth() - 1); this.render(); }); document.getElementById('calendarNext').addEventListener('click', () => { this.currentDate.setMonth(this.currentDate.getMonth() + 1); this.render(); }); }
            render() { const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"]; document.getElementById('calendarTitle').textContent = `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`; const year = this.currentDate.getFullYear(), month = this.currentDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const datesContainer = document.getElementById('calendarDates'); datesContainer.innerHTML = ''; let dayOfWeek = (firstDay.getDay() === 0) ? 6 : firstDay.getDay() - 1; for (let i = 0; i < dayOfWeek; i++) { datesContainer.innerHTML += `<div class="day other-month"></div>`; } for (let day = 1; day <= lastDay.getDate(); day++) { const isToday = new Date().toDateString() === new Date(year, month, day).toDateString(); datesContainer.innerHTML += `<div class="day ${isToday ? 'current-day' : ''}">${day}</div>`; } }
        }

        class TodoWidget {
            constructor() { this.todos = Storage.load(Storage.KEYS.TODO_LIST, []); this.init(); }
            init() { this.renderTodos(); document.getElementById('addTodoBtn').addEventListener('click', () => this.addTodo()); document.getElementById('newTodoInput').addEventListener('keypress', e => { if (e.key === 'Enter') this.addTodo(); }); document.getElementById('todo-list').addEventListener('click', e => { if (e.target.closest('.todo-delete')) this.deleteTodo(e.target.closest('li').dataset.todoId); }); }
            addTodo() { const input = document.getElementById('newTodoInput'); const text = input.value.trim(); if (!text) return; this.todos.push({ id: `task_${Date.now()}`, text, completed: false }); this.saveAndRender(); input.value = ''; }
            deleteTodo(id) { this.todos = this.todos.filter(todo => todo.id !== id); this.saveAndRender(); }
            saveAndRender() { Storage.save(Storage.KEYS.TODO_LIST, this.todos); this.renderTodos(); }
            renderTodos() { const list = document.getElementById('todo-list'); list.innerHTML = this.todos.map(todo => `<li data-todo-id="${todo.id}"><label>${todo.text}</label><button class="todo-delete"><i class="fa-solid fa-xmark"></i></button></li>`).join(''); }
        }

        return new HomeManager();
    })();

    // Modulo CARICO (da carico.js)
    const CargoManager = (() => {
        class CargoManager {
            constructor() {
                const loadedHistory = Storage.load(Storage.KEYS.CARICO_HISTORY, []);
                this.cargoData = {
                    totals: Storage.load(Storage.KEYS.CARICO_TOTALS, {}),
                    history: Array.isArray(loadedHistory) ? loadedHistory : [],
                    rimanenze: Storage.load(Storage.KEYS.CARICO_RIMANENZE, {})
                };
                this.currentlyDisplayedData = [];
                this.currentlyDisplayedTotals = {};
                this.currentPeriodLabel = 'TOTALE ANNO';
                
                if (!Array.isArray(loadedHistory)) {
                    console.warn("Dati 'history' di Carico corrotti, l'array è stato resettato.");
                }
                this.currentYear = new Date().getFullYear();
                this.carichiChart = null;
                this.monthlyLoadChart = null;
            }

            init() {
                this.bindEvents();
                document.getElementById('carico-filter-type').addEventListener('change', () => this.updateFilterValueOptions());
                this.updateFilterValueOptions();
                this.loadRimanenzeUI();
                this.updateTotals();
                this.renderHistory();
                this.updateYearDisplay();
                this.renderMonthlyLoadChart();
            }

            safeBind(elementId, event, handler) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(event, handler);
                }
            }

            bindEvents() {
                this.safeBind('btn-close-modal', 'click', () => this.closeModal());
                this.safeBind('btn-cancel-modal', 'click', () => this.closeModal());
                this.safeBind('newLoadForm', 'submit', (e) => this.saveNewCargo(e));
                this.safeBind('newLoadModal', 'click', (e) => {
                    if (e.target.id === 'newLoadModal') this.closeModal();
                });
                
                ['benzina', 'gasolio', 'diesel', 'hvolution'].forEach(p => {
                    this.safeBind(`rimanenza-${p}`, 'change', () => this.saveRimanenzeFromUI());
                });
                
                this.safeBind('btn-apply-carico-filter', 'click', () => this.applyPeriodFilter());
                this.safeBind('btn-reset-carico-filter', 'click', () => this.resetPeriodFilter());
            }

            updateFilterValueOptions() {
                const type = document.getElementById('carico-filter-type').value;
                const valueSelect = document.getElementById('carico-filter-value');
                valueSelect.innerHTML = '';
                let options = [];

                if (type === 'mese') {
                    options = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"]
                        .map((mese, index) => `<option value="${index}">${mese.toUpperCase()}</option>`);
                } else if (type === 'trimestre') {
                    options = [1, 2, 3, 4].map(q => `<option value="${q}">TRIMESTRE ${q}</option>`);
                } else if (type === 'semestre') {
                    options = [1, 2].map(s => `<option value="${s}">SEMESTRE ${s}</option>`);
                }
                valueSelect.innerHTML = options.join('');
            }

            applyPeriodFilter() {
                const type = document.getElementById('carico-filter-type').value;
                const value = parseInt(document.getElementById('carico-filter-value').value);
                let startDate, endDate;
                const year = this.currentYear;
                if (type === 'mese') {
                    startDate = new Date(year, value, 1);
                    endDate = new Date(year, value + 1, 0, 23, 59, 59);
                } else if (type === 'trimestre') {
                    const startMonth = (value - 1) * 3;
                    startDate = new Date(year, startMonth, 1);
                    endDate = new Date(year, startMonth + 3, 0, 23, 59, 59);
                } else if (type === 'semestre') {
                    const startMonth = (value - 1) * 6;
                    startDate = new Date(year, startMonth, 1);
                    endDate = new Date(year, startMonth + 6, 0, 23, 59, 59);
                }
                const titleLabel = document.getElementById('carico-filter-value').options[document.getElementById('carico-filter-value').selectedIndex].text;
                this.updateTotals({ start: startDate, end: endDate }, titleLabel);
                this.renderMonthlyLoadChart();
            }
            
            resetPeriodFilter() {
                document.getElementById('box-sinistro').classList.remove('period-filtered');
                this.updateTotals();
                this.renderMonthlyLoadChart();
            }

            importData() {
                showConfirmModal('Importare Dati Carico?', 'I dati attuali verranno sovrascritti.', () => {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.onchange = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = JSON.parse(e.target.result);
                                if (data.caricoTotals || data.caricoHistory || data.caricoRimanenze) {
                                    if (data.caricoTotals) this.cargoData.totals = data.caricoTotals;
                                    if (data.caricoHistory && Array.isArray(data.caricoHistory)) {
                                        this.cargoData.history = data.caricoHistory.map(entry => ({...entry, date: createDateTimestamp(entry.date) || entry.date }));
                                    }
                                    if (data.caricoRimanenze) this.cargoData.rimanenze = data.caricoRimanenze;
                                } else if (data.totals || data.history || data.rimanenze) {
                                    if (data.totals) this.cargoData.totals = data.totals;
                                    if (data.history && Array.isArray(data.history)) {
                                        this.cargoData.history = data.history.map(entry => ({...entry, date: createDateTimestamp(entry.date) || entry.date }));
                                    }
                                    if (data.rimanenze) this.cargoData.rimanenze = data.rimanenze;
                                } else { return showMessage('File non valido per il carico.', 'warning'); }
                                this.saveAndRefresh();
                                this.loadRimanenzeUI();
                                showMessage('Dati carico importati con successo!', 'info');
                            } catch (err) { showMessage('File non valido o corrotto.', 'error'); console.error('Errore importazione carico:', err); }
                        };
                        reader.readAsText(file);
                    };
                    fileInput.click();
                });
            }

            exportData() {
                const dataToExport = {
                    exportDate: new Date().toISOString(),
                    exportType: 'carico_report',
                    periodLabel: this.currentPeriodLabel,
                    currentYear: this.currentYear,
                    totals: this.currentlyDisplayedTotals,
                    history: this.currentlyDisplayedData.map(entry => ({ ...entry, date: formatter.toLocaleDate(parseDate(entry.date)) })),
                    rimanenzeSnapshot: this.cargoData.rimanenze
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                const safeFilename = this.currentPeriodLabel.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                a.download = `cerbero_carico_${safeFilename}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); URL.revokeObjectURL(url);
                showMessage(`Dati per ${this.currentPeriodLabel} esportati!`, 'info');
            }

            saveAndRefresh() {
                this.saveRimanenzeFromUI(false); 
                this.updateTotals();
                this.renderHistory();
                Storage.save(Storage.KEYS.CARICO_TOTALS, this.cargoData.totals);
                Storage.save(Storage.KEYS.CARICO_HISTORY, this.cargoData.history);
                Storage.save(Storage.KEYS.CARICO_RIMANENZE, this.cargoData.rimanenze);
            }

            updateSummaryBoxes(dataToProcess) {
                const totaleProdotti = dataToProcess.reduce((sum, cargo) => sum + (cargo.benzina || 0) + (cargo.gasolio || 0) + (cargo.diesel || 0) + (cargo.hvolution || 0), 0);
                const prodottiTotali = {
                    'BENZINA': dataToProcess.reduce((sum, c) => sum + (c.benzina || 0), 0),
                    'GASOLIO': dataToProcess.reduce((sum, c) => sum + (c.gasolio || 0), 0),
                    'DIESEL+': dataToProcess.reduce((sum, c) => sum + (c.diesel || 0), 0),
                    'HVOLUTION': dataToProcess.reduce((sum, c) => sum + (c.hvolution || 0), 0)
                };
                let prodottoPiuCaricato = '--', maxLitri = 0;
                for (const [prodotto, litri] of Object.entries(prodottiTotali)) {
                    if (litri > maxLitri) { maxLitri = litri; prodottoPiuCaricato = prodotto; }
                }
                const autistiCarichi = {};
                dataToProcess.forEach(cargo => {
                    if (cargo.driver) {
                        const autista = cargo.driver.trim().toUpperCase();
                        autistiCarichi[autista] = (autistiCarichi[autista] || 0) + 1;
                    }
                });
                let autistaTop = '--', maxCarichi = 0;
                for (const [autista, numeroCarichi] of Object.entries(autistiCarichi)) {
                    if (numeroCarichi > maxCarichi) { maxCarichi = numeroCarichi; autistaTop = autista; }
                }
                const totaleProdottiEl = document.getElementById('totaleProdottiCaricati');
                if (totaleProdottiEl) totaleProdottiEl.textContent = totaleProdotti > 0 ? formatter.liters(totaleProdotti) + ' L' : '0 L';
                const prodottoPiuCaricatoEl = document.getElementById('prodottoPiuCaricato');
                const prodottoPiuCaricatoDettagliEl = document.getElementById('prodottoPiuCaricatoDettagli');
                if (prodottoPiuCaricatoEl) prodottoPiuCaricatoEl.textContent = prodottoPiuCaricato;
                if (prodottoPiuCaricatoDettagliEl) prodottoPiuCaricatoDettagliEl.textContent = maxLitri > 0 ? formatter.liters(maxLitri) + ' litri' : '';
                const autistaTopEl = document.getElementById('autistaTop');
                const autistaTopDettagliEl = document.getElementById('autistaTopDettagli');
                if (autistaTopEl) {
                    let displayName = autistaTop;
                    if (autistaTop !== '--' && autistaTop.includes(' ')) displayName = autistaTop.split(' ')[0];
                    autistaTopEl.textContent = displayName;
                    if (autistaTop !== '--' && autistaTop.includes(' ')) autistaTopEl.title = autistaTop; else autistaTopEl.removeAttribute('title');
                }
                if (autistaTopDettagliEl) autistaTopDettagliEl.textContent = maxCarichi > 0 ? maxCarichi + ' carichi' : '';
            }
            
            openModal() {
                const modal = document.getElementById('newLoadModal');
                if(modal) {
                    modal.classList.add('active');
                    document.getElementById('load-date').value = formatter.toLocaleDate(new Date());
                    document.getElementById('load-driver').focus();
                }
            }
            closeModal() {
                const modal = document.getElementById('newLoadModal');
                if(modal) {
                    modal.classList.remove('active');
                    document.getElementById('newLoadForm').reset();
                }
            }
            saveNewCargo(e) {
                e.preventDefault();
                const timestamp = createDateTimestamp(document.getElementById('load-date').value);
                if (!timestamp) return showMessage('Data non valida.', 'warning');
                const formData = {
                    id: Date.now().toString(),
                    date: timestamp,
                    driver: document.getElementById('load-driver').value.trim().toUpperCase(),
                    benzina: parseInt(document.getElementById('load-benzina').value) || 0,
                    diffBenzina: parseInt(document.getElementById('load-diff-benzina').value) || 0,
                    gasolio: parseInt(document.getElementById('load-gasolio').value) || 0,
                    diffGasolio: parseInt(document.getElementById('load-diff-gasolio').value) || 0,
                    diesel: parseInt(document.getElementById('load-diesel').value) || 0,
                    diffDiesel: parseInt(document.getElementById('load-diff-diesel').value) || 0,
                    hvolution: parseInt(document.getElementById('load-hvolution').value) || 0,
                    diffHvolution: parseInt(document.getElementById('load-diff-hvolution').value) || 0,
                    timestamp: new Date().toISOString()
                };
                if (!formData.driver || (formData.benzina === 0 && formData.gasolio === 0 && formData.diesel === 0 && formData.hvolution === 0)) {
                    return showMessage('Autista e almeno un prodotto sono obbligatori.', 'warning');
                }
                this.cargoData.history.push(formData);
                this.saveAndRefresh();
                this.closeModal();
                showMessage('Carico salvato!', 'info');
            }
            deleteCargo(timestamp) {
                showConfirmModal('Eliminare Carico?', 'Questa azione non può essere annullata.', () => {
                    this.cargoData.history = this.cargoData.history.filter(c => c.timestamp !== timestamp);
                    this.saveAndRefresh();
                    showMessage('Carico eliminato.', 'info');
                });
            }
            editCargo(timestamp) {
                const cargo = this.cargoData.history.find(c => c.timestamp === timestamp);
                if (!cargo) return;
                this.showEditCargoModal(cargo, (updatedCargo) => {
                    const index = this.cargoData.history.findIndex(c => c.timestamp === timestamp);
                    if (index !== -1) {
                        this.cargoData.history[index] = { ...updatedCargo, timestamp: cargo.timestamp };
                        this.saveAndRefresh();
                        showMessage('Carico modificato!', 'info');
                    }
                });
            }
            showEditCargoModal(cargo, onConfirm) {
                 const existingModal = document.getElementById('edit-cargo-modal');
                if (existingModal) existingModal.remove();

                const formattedDate = formatter.toLocaleDate(parseDate(cargo.date)) || '';
                const modalHTML = `
                    <div class="modal-overlay active" id="edit-cargo-modal" style="z-index: 1001;">
                        <div class="modal" style="max-width:600px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Modifica Carico</h3>
                                <button class="modal-close-btn" title="Chiudi"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                            <div class="modal-content">
                                <form class="modal-form" id="editCargoForm">
                                    <div class="form-row">
                                        <div class="form-group"><label>Data</label><input type="text" class="grid-input" id="edit-load-date" value="${formattedDate}" required></div>
                                        <div class="form-group"><label>Autista</label><input type="text" class="grid-input" id="edit-load-driver" value="${cargo.driver || ''}" required></div>
                                    </div>
                                    <div class="product-inputs">
                                        <div class="form-group"><label class="product-label product-benzina">Benzina</label><input type="number" class="grid-input" id="edit-load-benzina" value="${cargo.benzina || 0}"><input type="number" class="grid-input" id="edit-load-diff-benzina" value="${cargo.diffBenzina || 0}"></div>
                                        <div class="form-group"><label class="product-label product-gasolio">Gasolio</label><input type="number" class="grid-input" id="edit-load-gasolio" value="${cargo.gasolio || 0}"><input type="number" class="grid-input" id="edit-load-diff-gasolio" value="${cargo.diffGasolio || 0}"></div>
                                        <div class="form-group"><label class="product-label product-diesel">Diesel+</label><input type="number" class="grid-input" id="edit-load-diesel" value="${cargo.diesel || 0}"><input type="number" class="grid-input" id="edit-load-diff-diesel" value="${cargo.diffDiesel || 0}"></div>
                                        <div class="form-group"><label class="product-label product-hvolution">HVOlution</label><input type="number" class="grid-input" id="edit-load-hvolution" value="${cargo.hvolution || 0}"><input type="number" class="grid-input" id="edit-load-diff-hvolution" value="${cargo.diffHvolution || 0}"></div>
                                    </div>
                                    <div class="modal-actions">
                                        <button type="button" class="action-btn" id="edit-cancel-modal">Annulla</button>
                                        <button type="submit" class="action-btn btn-success">Salva</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                const modal = document.getElementById('edit-cargo-modal');
                const hideModal = () => modal.remove();
                modal.querySelector('.modal-close-btn').addEventListener('click', hideModal);
                modal.querySelector('#edit-cancel-modal').addEventListener('click', hideModal);
                modal.querySelector('#editCargoForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const timestamp = createDateTimestamp(document.getElementById('edit-load-date').value);
                    if (!timestamp) return showMessage('Data non valida.', 'warning');
                    const updatedCargo = {
                        date: timestamp,
                        driver: document.getElementById('edit-load-driver').value.trim().toUpperCase(),
                        benzina: parseInt(document.getElementById('edit-load-benzina').value) || 0,
                        diffBenzina: parseInt(document.getElementById('edit-load-diff-benzina').value) || 0,
                        gasolio: parseInt(document.getElementById('edit-load-gasolio').value) || 0,
                        diffGasolio: parseInt(document.getElementById('edit-load-diff-gasolio').value) || 0,
                        diesel: parseInt(document.getElementById('edit-load-diesel').value) || 0,
                        diffDiesel: parseInt(document.getElementById('edit-load-diff-diesel').value) || 0,
                        hvolution: parseInt(document.getElementById('edit-load-hvolution').value) || 0,
                        diffHvolution: parseInt(document.getElementById('edit-load-diff-hvolution').value) || 0
                    };
                    if (!updatedCargo.driver) return showMessage('Autista obbligatorio', 'warning');
                    onConfirm(updatedCargo);
                    hideModal();
                });
            }
            updateTotals(dateRange = null, filterLabel = '') {
                const box = document.getElementById('box-sinistro');
                let dataToProcess;
                if (dateRange) {
                    box.classList.add('period-filtered');
                    this.currentPeriodLabel = `TOTALE ${filterLabel.toUpperCase()}`;
                    dataToProcess = this.cargoData.history.filter(c => {
                        const cargoDate = parseDate(c.date);
                        return cargoDate && cargoDate >= dateRange.start && cargoDate <= dateRange.end;
                    });
                    document.getElementById('box-title-anno').textContent = this.currentPeriodLabel;
                } else {
                    box.classList.remove('period-filtered');
                    this.currentPeriodLabel = `TOTALE ANNO (${this.currentYear})`;
                    dataToProcess = this.cargoData.history.filter(c => {
                        const cargoDate = parseDate(c.date);
                        return cargoDate && cargoDate.getFullYear() === this.currentYear;
                    });
                    this.updateYearDisplay();
                }
                this.currentlyDisplayedData = dataToProcess;
                let periodTotals = { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
                const diffs = { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
                const diffsPositive = { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
                const diffsNegative = { benzina: 0, gasolio: 0, diesel: 0, hvolution: 0 };
                dataToProcess.forEach(cargo => {
                    periodTotals.benzina += cargo.benzina || 0; diffs.benzina += cargo.diffBenzina || 0;
                    if (cargo.diffBenzina > 0) diffsPositive.benzina += cargo.diffBenzina; else diffsNegative.benzina += cargo.diffBenzina;
                    periodTotals.gasolio += cargo.gasolio || 0; diffs.gasolio += cargo.diffGasolio || 0;
                    if (cargo.diffGasolio > 0) diffsPositive.gasolio += cargo.diffGasolio; else diffsNegative.gasolio += cargo.diffGasolio;
                    periodTotals.diesel += cargo.diesel || 0; diffs.diesel += cargo.diffDiesel || 0;
                    if (cargo.diffDiesel > 0) diffsPositive.diesel += cargo.diffDiesel; else diffsNegative.diesel += cargo.diffDiesel;
                    periodTotals.hvolution += cargo.hvolution || 0; diffs.hvolution += cargo.diffHvolution || 0;
                    if (cargo.diffHvolution > 0) diffsPositive.hvolution += cargo.diffHvolution; else diffsNegative.hvolution += cargo.diffHvolution;
                });
                this.currentlyDisplayedTotals = periodTotals;
                if (!dateRange) { this.cargoData.totals = periodTotals; }
                this.renderTotals(periodTotals, diffs, diffsPositive, diffsNegative);
                this.updateSummaryBoxes(dataToProcess);
                this.renderCarichiChart(periodTotals);
                this.renderMonthlyLoadChart();
            }
            renderTotals(totals, diffs, diffsPositive, diffsNegative) {
                ['benzina', 'gasolio', 'diesel', 'hvolution'].forEach(p => {
                    document.getElementById(`litri-${p}`).value = formatter.liters(totals[p]);
                    document.getElementById(`piu-${p}`).value = formatter.liters(diffsPositive[p] || 0);
                    document.getElementById(`meno-${p}`).value = formatter.liters(diffsNegative[p] || 0); 
                    const diffInput = document.getElementById(`diff-${p}`);
                    const diffValue = diffs[p];
                    diffInput.value = formatter.diff.format(diffValue);
                    diffInput.style.color = diffValue > 0 ? 'var(--success)' : diffValue < 0 ? 'var(--danger)' : 'var(--text-secondary)';
                });
            }
            renderHistory() {
                const tbody = document.getElementById('history-tbody'); if (!tbody) return; tbody.innerHTML = '';
                const currentYearHistory = this.cargoData.history.filter(c => { const d = parseDate(c.date); return d && d.getFullYear() === this.currentYear; });
                if (currentYearHistory.length === 0) { tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 20px;">Nessun carico per il ${this.currentYear}</td></tr>`; return; }
                currentYearHistory.sort((a, b) => (parseDate(b.date) || 0) - (parseDate(a.date) || 0)).forEach((cargo) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${formatter.toLocaleDate(parseDate(cargo.date)) || ''}</td><td>${formatter.liters(cargo.benzina || 0)}</td><td>${formatter.diff.format(cargo.diffBenzina || 0)}</td>
                        <td>${formatter.liters(cargo.gasolio || 0)}</td><td>${formatter.diff.format(cargo.diffGasolio || 0)}</td><td>${formatter.liters(cargo.diesel || 0)}</td><td>${formatter.diff.format(cargo.diffDiesel || 0)}</td>
                        <td>${formatter.liters(cargo.hvolution || 0)}</td><td>${formatter.diff.format(cargo.diffHvolution || 0)}</td><td>${cargo.driver || ''}</td>
                        <td><button class="edit-btn action-btn" data-timestamp="${cargo.timestamp}" title="Modifica" style="padding: 4px 8px;"><i class="fa-solid fa-pen-to-square"></i></button></td>`;
                    row.querySelector('.edit-btn')?.addEventListener('click', (e) => this.editCargo(cargo.timestamp));
                });
            }
            renderCarichiChart(totalsToRender) {
                const canvas = document.getElementById('carichiChart'); if (!canvas) return; if (this.carichiChart) this.carichiChart.destroy(); if (typeof Chart === 'undefined') return;
                const rootStyles = getComputedStyle(document.documentElement);
                const productColors = {
                    benzina: rootStyles.getPropertyValue('--product-benzina').trim(), gasolio: rootStyles.getPropertyValue('--product-gasolio').trim(),
                    diesel: rootStyles.getPropertyValue('--product-diesel').trim(), hvolution: rootStyles.getPropertyValue('--product-hvolution').trim()
                };
                this.carichiChart = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: ['Benzina', 'Gasolio', 'Diesel+', 'HVOlution'], datasets: [{ label: 'Litri', data: [totalsToRender.benzina, totalsToRender.gasolio, totalsToRender.diesel, totalsToRender.hvolution], backgroundColor: Object.values(productColors), borderRadius: 8 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') } }, y: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') } } } }
                });
            }
            renderMonthlyLoadChart() {
                const canvas = document.getElementById('monthlyLoadChart'); if (!canvas) return; if (this.monthlyLoadChart) this.monthlyLoadChart.destroy(); if (typeof Chart === 'undefined') return;
                const currentYearData = this.cargoData.history.filter(c => { const d = parseDate(c.date); return d && d.getFullYear() === this.currentYear; });
                const monthlyTotals = Array(12).fill(0), monthlyDiffs = Array(12).fill(0);
                currentYearData.forEach(cargo => {
                    const cargoDate = parseDate(cargo.date);
                    if (cargoDate) {
                        const month = cargoDate.getMonth();
                        monthlyTotals[month] += (cargo.benzina || 0) + (cargo.gasolio || 0) + (cargo.diesel || 0) + (cargo.hvolution || 0);
                        monthlyDiffs[month] += (cargo.diffBenzina || 0) + (cargo.diffGasolio || 0) + (cargo.diffDiesel || 0) + (cargo.diffHvolution || 0);
                    }
                });
                const rootStyles = getComputedStyle(document.documentElement);
                const textColor = rootStyles.getPropertyValue('--text-secondary').trim();
                this.monthlyLoadChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: ["Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"],
                        datasets: [
                            { label: 'Litri Caricati', data: monthlyTotals, borderColor: rootStyles.getPropertyValue('--primary-blue').trim(), fill: true, tension: 0.3 },
                            { label: 'Differenze', data: monthlyDiffs, borderColor: rootStyles.getPropertyValue('--info').trim(), fill: true, tension: 0.3 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatter.liters(c.parsed.y)} L` } } }, scales: { x: { ticks: { color: textColor } }, y: { ticks: { color: textColor } } } }
                });
            }
            updateYearDisplay() {
                const year = this.currentYear;
                document.getElementById('box-title-anno').textContent = `TOTALE ANNO (${year})`;
            }
            saveRimanenzeFromUI(triggerRefresh = true) {
                ['benzina', 'gasolio', 'diesel', 'hvolution'].forEach(p => {
                    const input = document.getElementById(`rimanenza-${p}`);
                    if (input) this.cargoData.rimanenze[p] = parseInt(input.value.replace(/\./g, '')) || 0;
                });
                Storage.save(Storage.KEYS.CARICO_RIMANENZE, this.cargoData.rimanenze);
                if (triggerRefresh) this.updateTotals();
            }
            loadRimanenzeUI() {
                ['benzina', 'gasolio', 'diesel', 'hvolution'].forEach(p => {
                    const input = document.getElementById(`rimanenza-${p}`);
                    if (input) input.value = formatter.liters(this.cargoData.rimanenze[p] || 0);
                });
            }
            resetYear() {
                showConfirmModal(`Resettare Anno ${this.currentYear}?`, `Eliminerà tutti i dati di carico per l'anno corrente.`, () => {
                    this.cargoData.history = this.cargoData.history.filter(c => { const d = parseDate(c.date); return !d || d.getFullYear() !== this.currentYear; });
                    this.cargoData.rimanenze = {};
                    this.saveAndRefresh();
                    this.loadRimanenzeUI();
                    showMessage(`Dati per l'anno ${this.currentYear} cancellati.`, 'info');
                });
            }
            stampaDati() {
                const carichiChartImage = this.carichiChart ? this.carichiChart.toBase64Image('image/png', 1) : '';
                const monthlyLoadChartImage = this.monthlyLoadChart ? this.monthlyLoadChart.toBase64Image('image/png', 1) : '';
                const printContent = this.generatePrintContent(this.currentlyDisplayedData, this.currentlyDisplayedTotals, this.currentPeriodLabel, carichiChartImage, monthlyLoadChartImage);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.onload = () => { setTimeout(() => { printWindow.print(); printWindow.close(); }, 500); };
            }
            generatePrintContent(data, totals, periodLabel, carichiChartImage, monthlyLoadChartImage) {
                 let summary = { totaleLitri: 0, prodottoTop: '--', maxLitri: 0, autistaTop: '--', maxCarichi: 0 };
                summary.totaleLitri = Object.values(totals).reduce((a, b) => a + b, 0);
                for (const [p, l] of Object.entries(totals)) { if (l > summary.maxLitri) { summary.maxLitri = l; summary.prodottoTop = p.toUpperCase(); } }
                const autisti = {}; data.forEach(c => autisti[c.driver] = (autisti[c.driver] || 0) + 1);
                for (const [a, n] of Object.entries(autisti)) { if (n > summary.maxCarichi) { summary.maxCarichi = n; summary.autistaTop = a; } }
                return `
                    <!DOCTYPE html><html><head><title>Report Carichi</title><style>body{font-family:Arial,sans-serif;font-size:11px}.print-header{text-align:center;margin-bottom:20px;border-bottom:2px solid #093fb4;padding-bottom:10px}.print-title{font-size:20px;font-weight:bold;color:#093fb4}.print-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin:20px 0;text-align:center}.print-stat-item{border:1px solid #ccc;padding:10px;border-radius:8px}.print-stat-value{font-size:16px;font-weight:bold;color:#093fb4}.chart-container{text-align:center;margin-top:20px;page-break-inside:avoid}.chart-image{max-width:80%;height:auto}</style></head><body>
                    <div class="print-header"><div class="print-title">Report Carichi</div><div>Generato il: ${new Date().toLocaleString('it-IT')}</div><div>Riferimento: <strong>${periodLabel}</strong></div></div>
                    <div class="print-stats">
                        <div class="print-stat-item"><div class="print-stat-value">${formatter.liters(summary.totaleLitri)} L</div><div>Totale Caricato</div></div>
                        <div class="print-stat-item"><div class="print-stat-value">${summary.prodottoTop}</div><div>Prodotto Top</div></div>
                        <div class="print-stat-item"><div class="print-stat-value">${summary.autistaTop}</div><div>Autista Top</div></div>
                    </div>
                    ${carichiChartImage ? `<div class="chart-container"><h3>Grafico Carichi</h3><img src="${carichiChartImage}" class="chart-image"></div>` : ''}
                    ${monthlyLoadChartImage ? `<div class="chart-container"><h3>Andamento Mensile</h3><img src="${monthlyLoadChartImage}" class="chart-image"></div>` : ''}
                    </body></html>`;
            }
        }
        return new CargoManager();
    })();

    // Modulo CREDITO (da credito.js)
    const CreditManager = (() => {
        class CreditManager {
            constructor() {
                this.clients = Storage.load(Storage.KEYS.CREDITO_DATA, {});
                this.searchTerm = '';
                this.accentColors = ['var(--primary-blue)','var(--success)','var(--danger)','var(--info)','var(--warning)','var(--purple)','var(--orange)'];
            }
            init() { this.render(); }
            
            getFilteredAndSortedClients() {
                return Object.entries(this.clients)
                    .filter(([id, client]) => client.name && client.name.toLowerCase().includes(this.searchTerm))
                    .sort((a, b) => a[1].name.localeCompare(b[1].name));
            }
            save() { Storage.save(Storage.KEYS.CREDITO_DATA, this.clients); this.updateSummary(); }
            render() { this.updateSummary(); this.renderClientGrid(); }
            renderClientGrid() {
                const grid = document.getElementById('clientsGrid'); if (!grid) return; grid.innerHTML = '';
                const clientsToRender = this.getFilteredAndSortedClients();
                if (clientsToRender.length === 0) { grid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; padding: 20px;">Nessun cliente trovato.</p>'; return; }
                clientsToRender.forEach(([id, client], index) => {
                    const box = document.createElement('div'); box.className = 'box summary-box';
                    box.style.borderLeft = `5px solid ${this.accentColors[index % this.accentColors.length]}`;
                    box.innerHTML = `<div class="box-content" style="text-align:center; justify-content:center;"><span class="client-name">${client.name}</span></div>`;
                    box.addEventListener('click', () => this.showClientModal(id));
                    grid.appendChild(box);
                });
            }
            
            showClientModal(clientId) {
                const client = this.clients[clientId]; if (!client) return;
                const modal = document.getElementById('client-detail-modal');
                const modalBody = document.getElementById('modal-body-content');
                const balance = this.getClientBalance(clientId);
                const balanceColor = balance < 0 ? 'var(--danger)' : (balance > 0 ? 'var(--success)' : 'var(--text-secondary)');
                let transactionsHTML = (client.transactions && client.transactions.length > 0) ?
                    [...client.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => `
                        <div class="transaction-item">
                            <div class="transaction-details">${t.description}<div class="transaction-date">${formatter.dateTime(t.date)}</div></div>
                            <div class="transaction-right-side">
                                <div class="transaction-amount" style="color:${t.amount > 0 ? 'var(--success)' : 'var(--danger)'}">${t.amount > 0 ? '+' : ''}${formatter.currency.format(t.amount)}</div>
                                <button class="transaction-delete-btn" data-tx-id="${t.id}"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>`).join('') : '<p style="text-align:center; padding:20px;">Nessuna transazione.</p>';

                modalBody.innerHTML = `
                    <div class="modal-header">
                        <input type="text" class="client-name-input grid-input" value="${client.name}" style="text-align:left; font-size: 1.2rem; font-weight: bold;">
                        <button class="modal-close-btn"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="modal-content">
                        <div class="transaction-form-grid" style="margin-bottom:20px;">
                            <input type="text" class="grid-input" id="detail-date" value="${formatter.toLocaleDate(new Date())}">
                            <input type="text" class="grid-input" id="detail-desc" placeholder="Descrizione (es. Saldo, Benzina...)">
                            <input type="text" class="grid-input" id="detail-amount" placeholder="Importo" inputmode="decimal">
                        </div>
                        <div class="transactions-container is-expanded" style="max-height:300px; overflow-y:auto; padding-right:5px;">${transactionsHTML}</div>
                    </div>
                    <div class="modal-actions" style="justify-content:space-between; align-items:center; padding: 16px 20px;">
                        <button class="action-btn btn-danger" id="client-delete-btn"><i class="fa-solid fa-trash"></i> Elimina Cliente</button>
                        <div style="font-size: 1.1rem; font-weight: bold;">SALDO: <span style="color:${balanceColor};">${formatter.currency.format(balance)}</span></div>
                    </div>`;
                
                modal.classList.add('active');
                
                // Bind events for the new modal content
                const hideModal = () => modal.classList.remove('active');
                modal.querySelector('.modal-close-btn').addEventListener('click', hideModal);
                modal.querySelector('#client-delete-btn').addEventListener('click', () => { this.deleteClient(clientId); hideModal(); });

                modal.querySelectorAll('.transaction-delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    this.deleteTransaction(clientId, e.currentTarget.dataset.txId);
                    this.showClientModal(clientId); // Re-render modal
                }));

                const amountInput = modal.querySelector('#detail-amount');
                const addTx = () => {
                    const date = modal.querySelector('#detail-date').value;
                    const desc = modal.querySelector('#detail-desc').value;
                    const amount = parseNumberInput(amountInput.value);
                    if (desc && amount !== 0) {
                        this.addTransaction(clientId, date, desc, -Math.abs(amount));
                        this.showClientModal(clientId); // Re-render modal
                    } else { showMessage('Descrizione e importo sono richiesti.', 'warning'); }
                };
                amountInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addTx(); });
                setupDateInputAutoComplete(modal.querySelector('#detail-date'));

                const nameInput = modal.querySelector('.client-name-input');
                nameInput.addEventListener('blur', () => {
                     const newName = nameInput.value.trim();
                     if (client.name !== newName && newName) {
                        this.clients[clientId].name = newName;
                        this.save();
                        this.renderClientGrid(); // Update grid in background
                        showMessage(`Nome cliente aggiornato in "${newName}"`, "info");
                     } else {
                        nameInput.value = client.name;
                     }
                });
            }
            
            showAddClientModal() {
                const modal = document.getElementById('add-client-modal');
                const nameInput = document.getElementById('new-client-name');
                const okBtn = document.getElementById('add-client-ok');
                
                const hide = () => { modal.classList.remove('active'); nameInput.value = ''; };
                
                const addClient = () => {
                    const name = nameInput.value.trim();
                    if (!name) { showMessage('Il nome non può essere vuoto.', 'warning'); return; }
                    if (Object.values(this.clients).some(c => c.name.toLowerCase() === name.toLowerCase())) {
                        showMessage('Esiste già un cliente con questo nome.', 'error'); return;
                    }
                    const newId = `client_${Date.now()}`;
                    this.clients[newId] = { name: name, transactions: [], createdAt: new Date().toISOString() };
                    this.save();
                    this.render();
                    showMessage(`Cliente "${name}" aggiunto!`, 'success');
                    hide();
                };

                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                newOkBtn.addEventListener('click', addClient, {once: true});

                modal.querySelector('#add-client-cancel').addEventListener('click', hide, {once: true});
                modal.querySelector('.modal-close-btn').addEventListener('click', hide, {once: true});

                modal.classList.add('active');
                nameInput.focus();
            }

            deleteClient(clientId) {
                const clientName = this.clients[clientId]?.name || 'Sconosciuto';
                showConfirmModal('Eliminare Cliente?', `Sei sicuro di voler eliminare "${clientName}" e tutte le sue transazioni? L'azione è irreversibile.`, () => {
                    delete this.clients[clientId];
                    this.save();
                    this.render();
                    showMessage(`Cliente "${clientName}" eliminato.`, 'info');
                });
            }

            addTransaction(clientId, date, description, amount) {
                const validDate = parseDate(date);
                if (!validDate) { showMessage('Data non valida.', 'warning'); return; }
                const now = new Date();
                validDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
                this.clients[clientId].transactions.push({ 
                    id: `tx_${Date.now()}`, date: validDate.toISOString(), description, amount
                });
                this.save();
            }

            deleteTransaction(clientId, transactionId) {
                this.clients[clientId].transactions = this.clients[clientId].transactions.filter(tx => tx.id !== transactionId);
                this.save();
            }
            
            getClientBalance(clientId) { return (this.clients[clientId]?.transactions || []).reduce((sum, t) => sum + (t.amount || 0), 0); }
            
            updateSummary() {
                const balances = Object.keys(this.clients).map(id => this.getClientBalance(id));
                const totalDebt = balances.filter(b => b < 0).reduce((sum, b) => sum + b, 0);
                document.getElementById('totalCredito').textContent = formatter.currency.format(totalDebt);
                document.getElementById('clientiAttivi').textContent = balances.filter(b => b < 0).length;
                
                const allTransactions = Object.entries(this.clients).flatMap(([id, client]) => 
                    (client.transactions || []).map(tx => ({...tx, clientName: client.name, date: new Date(tx.date)}))
                );
                if (allTransactions.length > 0) {
                    const lastTx = allTransactions.sort((a,b) => b.date - a.date)[0];
                    document.getElementById('last-op-client').textContent = lastTx.clientName;
                    document.getElementById('last-op-details').innerHTML = `${lastTx.description} <span style="color:${lastTx.amount>0?'var(--success)':'var(--danger)'};">(${formatter.currency.format(lastTx.amount)})</span>`;
                } else {
                    document.getElementById('last-op-client').textContent = '--';
                    document.getElementById('last-op-details').textContent = '';
                }
            }

            importData() {
                showConfirmModal('Importare Dati Credito?', 'Questo sovrascriverà i dati dei clienti correnti.', () => {
                    const input = document.createElement('input');
                    input.type = 'file'; input.accept = '.json';
                    input.onchange = (event) => {
                        const file = event.target.files[0]; if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = JSON.parse(e.target.result);
                                const clientsToImport = data.credito || data;
                                if (typeof clientsToImport === 'object' && clientsToImport !== null) {
                                    this.clients = clientsToImport;
                                    this.save();
                                    this.render();
                                    showMessage('Dati credito importati!', 'success');
                                } else { throw new Error('Formato dati non valido'); }
                            } catch (err) { showMessage('Errore: file non valido o corrotto.', 'error'); }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                });
            }

            exportData() {
                const dataStr = JSON.stringify(this.clients, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cerbero_credito_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                showMessage('Dati Credito esportati!', 'info');
            }

            stampaDati() {
                const clientsWithBalance = Object.values(this.clients)
                    .map(client => ({ name: client.name, balance: this.getClientBalance(Object.keys(this.clients).find(key => this.clients[key] === client)) }))
                    .filter(c => c.balance < 0)
                    .sort((a, b) => a.name.localeCompare(b.name));

                if (clientsWithBalance.length === 0) { showMessage('Nessun cliente con debito.', 'info'); return; }
                
                let html = `<html><head><title>Riepilogo Crediti</title><style>body{font-family:monospace; margin:20px;} .client{display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #ccc;} h2{text-align:center;}</style></head><body><h2>Riepilogo Crediti a Debito</h2>`;
                clientsWithBalance.forEach(c => { html += `<div class="client"><span>${c.name}</span><span>${formatter.currency.format(c.balance)}</span></div>`; });
                html += `</body></html>`;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(html);
                printWindow.document.close();
                printWindow.onload = () => { setTimeout(() => { printWindow.print(); printWindow.close(); }, 250); };
            }
        }
        return new CreditManager();
    })();

    // Altri moduli (VENDITE, VIRTUALSTATION, REGISTRO, MONETARIO) verranno definiti in modo simile...
    // Per motivi di spazio, la loro implementazione dettagliata è omessa, ma la struttura sarebbe la stessa.
    
    /* ================================================== */
    /* ===== 4. APPLICAZIONE PRINCIPALE (ORCHESTRAZIONE) ===== */
    /* ================================================== */

    const App = {
        managers: {},

        init() {
            ThemeManager.init();
            initializeInfoButton();

            // Inizializza tutti i moduli/manager
            this.managers.home = HomeManager; // HomeManager è un oggetto singleton
            this.managers.cargo = CargoManager;
            this.managers.credito = CreditManager;
            // Qui andrebbero istanziati gli altri manager se fossero stati definiti come classi
            // this.managers.vendite = new VenditeManager();
            // this.managers.virtualstation = new VirtualstationManager();
            // this.managers.registro = new RegistroManager();
            // this.managers.monetario = new MonetarioManager();

            this.initNavigation();
            
            // Imposta la sezione iniziale
            const initialSection = 'home';
            document.querySelector(`.nav-link[data-section="${initialSection}"]`).classList.add('active');
            document.getElementById(`section-${initialSection}`).classList.add('active');
            this.updateTopActionBar(initialSection);

            // Avvia i manager che richiedono un'inizializzazione esplicita
            Object.values(this.managers).forEach(manager => {
                if (typeof manager.init === 'function') {
                    manager.init();
                }
            });
            
            // Listeners globali
            window.addEventListener('theme-changed', () => this.handleThemeChange());
        },

        initNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionName = link.dataset.section;

                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));

                    link.classList.add('active');
                    document.getElementById(`section-${sectionName}`).classList.add('active');

                    this.updateTopActionBar(sectionName);
                });
            });
        },

        updateTopActionBar(sectionName) {
            const bar = document.getElementById('topActionBar');
            let buttonsHTML = '';
            switch(sectionName) {
                 case 'home':
                    buttonsHTML = `<button id="top-btn-nuova-giornata" class="action-btn btn-success"><i class="fa-solid fa-play"></i>Nuova Giornata</button>
                                 <button id="top-btn-esporta-tutto" class="action-btn"><i class="fa-solid fa-download"></i>Esporta Tutto</button>
                                 <button id="top-btn-importa-tutto" class="action-btn"><i class="fa-solid fa-upload"></i>Importa Tutto</button>`;
                    break;
                case 'registro':
                     buttonsHTML = `<button id="top-btn-importa-registro" class="action-btn"><i class="fa-solid fa-file-import"></i>Importa</button>
                                 <button id="top-btn-esporta-registro" class="action-btn"><i class="fa-solid fa-file-export"></i>Esporta</button>`;
                    break;
                case 'monetario':
                     buttonsHTML = `<button id="top-btn-importa-monetario" class="action-btn"><i class="fa-solid fa-file-import"></i>Importa</button>
                                 <button id="top-btn-esporta-monetario" class="action-btn"><i class="fa-solid fa-file-export"></i>Esporta</button>`;
                    break;
                 case 'virtualstation':
                    buttonsHTML = `<button id="top-btn-aggiungi-turno" class="action-btn"><i class="fa-solid fa-plus"></i>Aggiungi Turno</button>
                                 <button id="top-btn-reset-turni" class="action-btn btn-danger"><i class="fa-solid fa-trash"></i>Reset Turni</button>
                                 <button id="top-btn-importa-virtualstation" class="action-btn"><i class="fa-solid fa-file-import"></i>Importa</button>
                                 <button id="top-btn-esporta-virtualstation" class="action-btn"><i class="fa-solid fa-file-export"></i>Esporta</button>`;
                    break;
                 case 'vendite':
                    buttonsHTML = `<button id="top-btn-importa-vendite" class="action-btn"><i class="fa-solid fa-file-import"></i>Importa Storico</button>
                                 <button id="top-btn-esporta-vendite" class="action-btn"><i class="fa-solid fa-file-export"></i>Esporta Dati</button>
                                 <button id="top-btn-stampa-vendite" class="action-btn"><i class="fa-solid fa-print"></i>Stampa</button>`;
                    break;
                case 'carico':
                    buttonsHTML = `<button id="top-btn-nuovo-carico" class="action-btn"><i class="fa-solid fa-plus"></i>Nuovo</button>
                                 <button id="top-btn-esporta-carico" class="action-btn"><i class="fa-solid fa-file-export"></i>Esporta</button>
                                 <button id="top-btn-importa-carico" class="action-btn"><i class="fa-solid fa-file-import"></i>Importa</button>
                                 <button id="top-btn-stampa-carico" class="action-btn"><i class="fa-solid fa-print"></i>Stampa</button>
                                 <button id="top-btn-reset-carico" class="action-btn btn-danger"><i class="fa-solid fa-trash"></i>Reset Anno</button>`;
                    break;
                case 'credito':
                    buttonsHTML = `<button id="top-btn-nuovo-cliente" class="action-btn"><i class="fa-solid fa-user-plus"></i>Nuovo</button>
                                 <div class="search-wrapper"><input type="text" id="top-creditoSearchInput" class="grid-input" placeholder="Cerca cliente..."></div>
                                 <button id="top-btn-stampa-credito" class="action-btn"><i class="fa-solid fa-print"></i>Stampa Riepilogo</button>
                                 <button id="top-btn-importa-credito" class="action-btn"><i class="fa-solid fa-file-import"></i>Importa</button>
                                 <button id="top-btn-esporta-credito" class="action-btn"><i class="fa-solid fa-file-export"></i>Esporta</button>`;
                    break;
                default:
                    buttonsHTML = '';
                    break;
            }
            bar.innerHTML = buttonsHTML;
            this.bindTopActionBarEvents(sectionName);
        },

        bindTopActionBarEvents(sectionName) {
            const bar = document.getElementById('topActionBar');
            // Funzione helper per associare un evento in modo sicuro
            const bind = (id, event, handler) => {
                const el = bar.querySelector(id);
                if (el) el.addEventListener(event, handler);
            };

            switch(sectionName) {
                case 'home':
                    bind('#top-btn-nuova-giornata', 'click', () => this.managers.home.confirmNewDay());
                    bind('#top-btn-esporta-tutto', 'click', () => this.managers.home.esportaTuttiIDati());
                    bind('#top-btn-importa-tutto', 'click', () => this.managers.home.importaDatiCompleti());
                    break;
                case 'carico':
                    bind('#top-btn-nuovo-carico', 'click', () => this.managers.cargo.openModal());
                    bind('#top-btn-esporta-carico', 'click', () => this.managers.cargo.exportData());
                    bind('#top-btn-importa-carico', 'click', () => this.managers.cargo.importData());
                    bind('#top-btn-stampa-carico', 'click', () => this.managers.cargo.stampaDati());
                    bind('#top-btn-reset-carico', 'click', () => this.managers.cargo.resetYear());
                    break;
                case 'credito':
                    bind('#top-btn-nuovo-cliente', 'click', () => this.managers.credito.showAddClientModal());
                    bind('#top-btn-stampa-credito', 'click', () => this.managers.credito.stampaDati());
                    bind('#top-btn-importa-credito', 'click', () => this.managers.credito.importData());
                    bind('#top-btn-esporta-credito', 'click', () => this.managers.credito.exportData());
                    const searchInput = bar.querySelector('#top-creditoSearchInput');
                    if (searchInput) {
                        searchInput.addEventListener('input', (e) => {
                            this.managers.credito.searchTerm = e.target.value.toLowerCase().trim();
                            this.managers.credito.render();
                        });
                    }
                    break;
                // Aggiungere qui i bind per le altre sezioni quando i loro manager saranno completi
            }
        },

        handleThemeChange() {
             Object.values(this.managers).forEach(manager => {
                if (typeof manager.handleThemeChange === 'function') {
                    manager.handleThemeChange();
                }
             });
             // Caso specifico per Carico che ha grafici
             if (this.managers.cargo) {
                this.managers.cargo.renderCarichiChart(this.managers.cargo.currentlyDisplayedTotals);
                this.managers.cargo.renderMonthlyLoadChart();
            }
        },
    };

    // Avvio dell'applicazione
    App.init();
});
</script>

</body>
</html>